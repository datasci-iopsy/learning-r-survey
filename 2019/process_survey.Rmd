---
title: "Learning R Survey Results"
author: "Carl Howe, RStudio"
date: "03 January 2020"
output: html
params:
  bar_colors: "#77ADDB"
  language: Combined
---

# Learning R Survey Results

## Methodology

- Survey was fielded between December 16, 2019 and January 10, 2020.
- Survey was fielded in both English and Spanish versions
- Respondents solicited from
    + community.rstudio.com
    + Twitter followers of RStudio employees
- Survey results are not representative of any broader population
- Data and processing scripts can be found the repo at the end of this talk
- Data and scripts are open source

## Setup

```{r setup, include=FALSE}


knitr::opts_chunk$set(echo = FALSE)
options(htmltools.dir.version = FALSE)
library(googlesheets)
library(choroplethr)
library(choroplethrMaps)
data(country.map)
library(tidyverse)
library(RColorBrewer)
library(gendercodeR)
library(ggrepel)

survey_name = "2019 R Community Survey"

###
### Let's define helper functions before we get going:
###

# This tallies up the results for a question
# rm.na = TRUE to calculate percentages based on non-NA results; set to FALSE to include NAs
# set sort = TRUE sorts the result by count; set to FALSE to return in whatever order they occur

tally_question <-
  function(df,
           question_name,
           rm.na = TRUE,
           sort = TRUE) {
    quoted_question <- enquo(question_name)
    filtered_df <- df
    if (rm.na) {
      filtered_df <- filtered_df %>% 
        filter(!is.na(!!quoted_question))
    }
    results_df <- filtered_df %>%
      count(!!quoted_question, sort = sort) %>%
      add_tally(n, name = "nn") %>%
      mutate(percent = round(n / nn * 100, 1),
             prop_responses = n / nn)
    return(results_df)
}

# Split and aggregate: derives multiple answers to a single question by separating on commas and returning
# the results as an embedded list in the dataframe.
split_and_aggregate <- function(df, question_name) {
  quoted_question <- enquo(question_name)
  responses_df <- df %>%
    summarize(responses = sum(!is.na(!!quoted_question)))
  splits <- df %>%
    mutate(items = purrr::map(!!quoted_question, str_split, ", ")) %>%
    unnest(items)
  aggregated_items <- splits %>%
    unnest(items) %>%
    group_by(items) %>%
    count(sort = TRUE)
  aggregated_items <- aggregated_items %>%
    mutate(num_responses = responses_df$responses)
  return(aggregated_items)
}

# Top N choices: function to distill many possible results to a question to the top N
# responses, with the rest aggregated into an "Other" answer.
top_n_choices <-
  function(df, column_name, total_responses, num = 10) {
    quoted_column_name <- enquo(column_name)
    summarized_responses <- df %>%
      mutate(
        percent = round(n / total_responses * 100, 1),
        prop_responses = n / total_responses
      ) %>%
      arrange(desc(percent))
    
    # Now take these responses and only show the top N, aggregating the rest into an Other category
    
    literals <- head(summarized_responses, num) %>%
      ungroup()
    other <- tail(summarized_responses,-num) %>%
      ungroup() %>%
      summarize(
        !!quoted_column_name := "Other",
        n = sum(n),
        percent = round(n / first(total_responses) * 100, 1),
        prop_responses = n / first(total_responses)
      )
    top_n <- rbind(literals, other) %>% drop_na()
    return(top_n)
  }

question_text <-function(question_name_string,
           respondents_note = "",
           wrap_length = 55)
  {
    qtext <-
      survey_questions %>% filter(Question_name == question_name_string) %>% select(Question_text)
    if (str_length(qtext$Question_text) >= wrap_length) {
      return_text <-
        qtext$Question_text %>% str_wrap(width = wrap_length - 5)
    } else {
      return_text <- qtext$Question_text
    }
    return(paste0('"', return_text, '" ', respondents_note))
  }

## Plot a pie chart from a single response question. The call form is a little baroque, so here's an example
## to illustrate the mapping of values to arguments.
##     pie_chart(df = ethnicities,
##               column_name                 = Qethnicity_coded,
##               text_position_expression    = 100 - position  ## the name of the position column in the df
##               title_string                = "Ethnicities",
##               subtitle_string             =  question_text("Qethnicity", 50)
##               fill_legend_title           = "Respondent Ethnicity"
##               reverse_fill_legend         = FALSE
##               colors                      = "Set1"         From the RColorBrewer palettes


pie_chart <- function(df,
                      column_name,
                      # non-standard evalation column name
                      text_position_expression,
                      # either a column name or an expression
                      title_string = "",
                      subtitle_string = "",
                      caption_string = survey_name,
                      fill_legend_title = "",
                      reverse_fill_legend = FALSE,
                      colors = "Set1") {
  quoted_column_name <- enquo(column_name)
  quoted_position <- enquo(text_position_expression)
  p <- ggplot(df) +
    geom_col(
      aes(
        x = 1,
        y = round(percent),
        fill = !!quoted_column_name
      ),
      width = 1,
      size = 1,
      color = "gray90",
      alpha = 0.4
    ) +
    geom_text(
      aes(
        x = 1.22,
        y = !!quoted_position,
        label = label
      ),
      size = 3,
      hjust = 0.4,
      color = "black"
    ) +
    labs(
      x = NULL,
      y = NULL,
      subtitle = subtitle_string,
      caption = caption_string,
      fill = fill_legend_title
    ) +
    guides(fill = guide_legend()) +
    scale_fill_brewer(palette = colors) +
    #   scale_fill_viridis_d("Ethnicities", option = "A", direction = -1, alpha = 0.4) +
    guides(fill = guide_legend(reverse = reverse_fill_legend)) +
    theme(legend.key.width = unit(1, "cm")) +
    theme_classic() +
    coord_polar("y") +
    #    coord_flip() +
    theme(
      axis.line = element_blank(),
      axis.text = element_blank(),
      axis.ticks = element_blank(),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = "transparent", colour = NA),
      plot.background = element_rect(fill = "transparent", colour = NA)
    )
  print(p)
  plot_save(paste0(title_string, ".pdf"))
  return(p)
}

## Plot a simple horizontal bar chart. The call form is a little baroque, so here's an example
## to illustrate the mapping of values to arguments.
# bar_chart(df                     = r_education_results,
#           column_name            = Output,   # column name, in unquoted dplyr form
#           fill_color             = params$bar_colors,    # color for bars
#           title_string           = "Respondent Education Levels (All Respondents)",
#           subtitle_string        = question_text("Qdegree"),
#           caption_string         = paste0(survey_name, ", n = ", r_education_responses)

bar_chart <- function(df,
                      column_name,
                      fill_color,
                      title_string = "",
                      subtitle_string = "",
                      caption_string = survey_name) {
  quoted_column <- enquo(column_name)
  nudge_amount <- max(df$percent, rm.na = TRUE) * 0.05
  p <- ggplot(df) +
    geom_col(aes(x = !!quoted_column, y = percent),
             fill =  fill_color) +
    geom_text(
      aes(
        x = !!quoted_column,
        y = percent ,
        label = paste0(round(percent), "%")
      ),
      color = "gray30",
      size = 3,
      nudge_y = nudge_amount
    ) +
    labs(
      subtitle = subtitle_string,
      caption = caption_string,
      x = "",
      y = ""
    ) +
    coord_flip() +
    theme(
      axis.line = element_blank(),
      axis.text.x = element_blank(),
      axis.ticks = element_blank(),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = "transparent", colour = NA),
      plot.background = element_rect(fill = "transparent", colour = NA)
    )
  print(p)
  plot_save(paste0(title_string, ".pdf"))
  return(p)
}

## Plot a simple horizontal bar chart with counts instead of percentages.
## The call form is a little baroque, so here's an example
## to illustrate the mapping of values to arguments.
# bar_chart_counts(top_25_packages,   # data frame to plot
#           column_name = capability, # which column has the factor we're plotting; y always = column "n"
#           fill_color = params$bar_colors,
#           title_string = "Capabilities Users Cannot Live Without (R Users Only)",
#           subtitle_string = paste0(question_text("Qnot_live_without", 40), " (Number of mentions shown)"),
#           caption_string = paste0(survey_name, ", Total Mentions = ", num_package_responses))

bar_chart_counts <- function(df,
                             column_name,
                             fill_color,
                             title_string = "",
                             subtitle_string = "",
                             caption_string = survey_name) {
  quoted_column <- enquo(column_name)
  nudge_amount <- max(df$n, rm.na = TRUE) * 0.05
  p <- ggplot(df) +
    geom_col(aes(x = !!quoted_column, y = n),
             fill =  fill_color) +
    geom_text(
      aes(
        x = !!quoted_column,
        y = n ,
        label = n
      ),
      color = "gray30",
      size = 3,
      nudge_y = nudge_amount
    ) +
    labs(
      subtitle = subtitle_string,
      caption = caption_string,
      x = "",
      y = ""
    ) +
    coord_flip() +
    theme(
      axis.line = element_blank(),
      axis.text.x = element_blank(),
      axis.ticks = element_blank(),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = "transparent", colour = NA),
      plot.background = element_rect(fill = "transparent", colour = NA)
    )
  print(p)
  plot_save(paste0(title_string, ".pdf"))
  return(p)
}

# Chop and prop:
# input: a df, a column in that df, and (optional) number of "items" (unique responses to keep, top 15 is default)
# output: a df with the original quoted question name/items, the items as processed by fct_lump, and the n and prop_responses for plotting (need the proportions to take advantage of scales::percent when plotting)
chop_and_prop <- function(df, question_name, num_items = 15) {
  quoted_question <- enquo(question_name)
  responses <-
    df %>% summarize(responses = sum(!is.na(!!quoted_question))) %>% pull()
  chops <- df %>%
    mutate(items = str_remove(!!quoted_question, "i.e., ")) %>%
    tidyr::separate_rows(items, sep = ", ") %>%
    mutate(items = forcats::fct_lump(as.factor(items), n = num_items))
  prop_items <- chops %>%
    count(items) %>%
    tidyr::drop_na(items) %>%
    mutate(prop_responses = n / responses,
           total_responses = responses)
  return(prop_items)
}

## Plot a simple lollipop plot. Intended to be used after chop_and_prop
##     lollipop_chart(df = ethnicities,
##               column_name            = Qethnicity_coded,
##               original_column_string = "Qethnicity",
##               text_position          = position        ## the name of the position column in the df
##               title_string           = "Ethnicities",
##               fill_legend_title      = "Respondent Ethnicity"
##               colors                 = "Set1"         From the RColorBrewer palettes

lollipop_chart <- function(df,
                           column_name,
                           fill_color,
                           title_string = NULL,
                           subtitle_string = "",
                           caption_string = survey_name,
                           pct_accuracy = 1) {
  quoted_column <- enquo(column_name)
  nudge_amount <- max(df$prop_responses, na.rm = TRUE) * 0.05
  df <- df %>%
    mutate(xaxis_factor = suppressWarnings(fct_relevel(
      fct_reorder(!!quoted_column, prop_responses), "Other"
    )))
  p <- ggplot(df, aes(x = xaxis_factor,
                      y = prop_responses)) +
    geom_point(color = fill_color, size = 3) +
    geom_segment(
      aes(xend = fct_rev(!!quoted_column), yend = 0),
      color = fill_color,
      size = 1.5,
      alpha = .7
    ) +
   geom_text(aes(label = scales::percent(prop_responses, accuracy = pct_accuracy)),
             hjust = -.25,
             color = "black") +
    labs(
      title = title_string,
      subtitle = subtitle_string,
      caption = caption_string,
      x = "",
      y = ""
    ) +
    coord_flip() +
    scale_y_continuous(limits = c(0, max(df$n) * 1.05)) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1),
                       limits = c(0, max(df$prop_responses) * 1.05)) +
    theme(
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = "transparent", colour = NA),
      plot.background = element_rect(fill = "transparent", colour = NA)
    )
  print(p)
  #return(p)
}

## Plot a simple lollipop plot. Intended to be used after chop_and_prop
##     lollipop_chart(df = ethnicities,
##               column_name            = Qethnicity_coded,
##               original_column_string = "Qethnicity",
##               text_position          = position        ## the name of the position column in the df
##               title_string           = "Ethnicities",
##               fill_legend_title      = "Respondent Ethnicity"
##               colors                 = "Set1"         From the RColorBrewer palettes

lollipop_chart_100pc <- function(df,
                           column_name,
                           fill_color,
                           title_string = NULL,
                           subtitle_string = "",
                           caption_string = survey_name,
                           pct_accuracy = 1) {
  quoted_column <- enquo(column_name)
  nudge_amount <- max(df$prop_responses, na.rm = TRUE) * 0.05
  df <- df %>%
    mutate(xaxis_factor = suppressWarnings(fct_relevel(
      fct_reorder(!!quoted_column, prop_responses), "Other"
    )))
  p <- ggplot(df, aes(x = xaxis_factor,
                      y = prop_responses)) +
    geom_point(color = fill_color, size = 3) +
    geom_segment(
      aes(xend = fct_rev(!!quoted_column), yend = 0),
      color = fill_color,
      size = 1.5,
      alpha = .7
    ) +
   geom_text(aes(label = scales::percent(prop_responses, accuracy = pct_accuracy)),
             hjust = -.25,
             color = "black") +
    labs(
      title = title_string,
      subtitle = subtitle_string,
      caption = caption_string,
      x = "",
      y = ""
    ) +
    coord_flip() +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1),
                       limits = c(0, 1.05)) +
    theme(
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = "transparent", colour = NA),
      plot.background = element_rect(fill = "transparent", colour = NA)
    )
  print(p)
  #return(p)
}


## Plot a simple lollipop plot the plots counts instead of percentages.
## We assume the counts are in the variable named "n"
##     lollipop_chart_counts(df = ethnicities,
##               column_name            = Qethnicity_coded,
##               original_column_string = "Qethnicity",
##               text_position          = position        ## the name of the position column in the df
##               title_string           = "Ethnicities",
##               fill_legend_title      = "Respondent Ethnicity"
##               colors                 = "Set1"         From the RColorBrewer palettes

lollipop_chart_counts <- function(df,
                                  column_name,
                                  fill_color,
                                  title_string = NULL,
                                  subtitle_string = "",
                                  caption_string = survey_name,
                                  pct_accuracy = 1) {
  quoted_column <- enquo(column_name)
  nudge_amount <- max(df$n, na.rm = TRUE) * 0.05
  df <- df %>%
    mutate(xaxis_factor = suppressWarnings(fct_relevel(
      fct_reorder(!!quoted_column, n), "Other"
    )))
  p <- ggplot(df, aes(x = xaxis_factor,
                      y = n)) +
    geom_point(color = fill_color, size = 3) +
    geom_segment(
      aes(xend = fct_rev(!!quoted_column), yend = 0),
      color = fill_color,
      size = 1.5,
      alpha = .7
    ) +
    geom_text(aes(label = n),
              hjust = -0.9,
              color = "black",
              size = 3) +
    labs(
      title = title_string,
      subtitle = subtitle_string,
      caption = caption_string,
      x = "",
      y = ""
    ) +
    coord_flip() +
    scale_y_continuous(limits = c(0, max(df$n) * 1.05)) +
    theme(
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = "transparent", colour = NA),
      plot.background = element_rect(fill = "transparent", colour = NA)
    )
  print(p)
  #return(p)
}


# This routine is a replacement for ggsave, with the difference that it
# puts the plot in the appropriate language directory. So a save of the plot
# "foo.pdf" for the English version of the survey would end up in plots/English/foo.pdf.
plot_save <- function(pathname,
                      height = 4,
                      width = 8,
                      dpi = 600)
{
  ggsave(
    width = width,
    height = height,
    dpi = dpi,
    units = "in",
    bg = "transparent",
    here::here(paste0("plots/", pathname))
  )
}

```


```{r read processed survey, include = FALSE}
# for plots
survey_name <- "2019 R Community Survey"
# Before we start, let's define the columns and types of the survey

column_formats = cols(
  Qtime = col_character(),
  Qr_experience = col_character(),
  Qr_difficulty = col_double(),
  Qr_length_to_success = col_character(),
  Qhow_to_learn_r = col_character(),
  Qreason_to_learn = col_character(),
  Qr_use = col_character(),
  Qtools = col_character(),
  Qobstacles_to_starting = col_character(),
  Qr_year = col_double(),
  Qr_learning_path = col_character(),
  Qr_difficulty = col_double(),
  Qtime_to_proficiency = col_character(),
  Qreason_to_learn = col_character(),
  Qmost_difficult_aspect = col_character(),
  Qr_how_often_used = col_character(),
  Qused_for = col_character(),
  Qr_enjoyment = col_double(),
  Qrecommend = col_double(),
  Qtools_with_r = col_character(),
  Qtidyverse_learning = col_character(),
  Qtidyverse_today = col_character(),
  Qlike_best = col_character(),
  Qlike_least = col_character(),
  Qr_problems = col_character(),
  Qr_discover_packages = col_character(),
  Qr_share = col_character(),
  Qr_change = col_character(),
  Qrobot_test = col_character(),
  Qrmarkdown = col_character(),
  Qrmarkdown_apps = col_character(),
  Qrmarkdown_change = col_character(),
  Qshiny = col_character(),
  Qshiny_change  = col_character(),
  Qpython_use = col_character(),
  Qpython_apps = col_character(),
  Qpython_enjoy = col_double(),
  Qpython_recommend = col_double(),
  Qpython_change = col_character(),
  Qlanguages  = col_character(),
  Qfirst_language = col_character(),
  Qyear_born = col_double(),
  Qgender  = col_character(),
  Qethnicity  = col_character(),
  Qdegree  = col_character(),
  Qcountry  = col_character(),
  Qindustry  = col_character(),
  Qtitle  = col_character(),
  Qwork_title  = col_character(),
  Qteam_r_users = col_character(),
  Qevents  = col_character(),
  Qhear  = col_character()
)

# get the data
english_column_names <-
  read_tsv(here::here("data/survey-questions-2019-en.tsv"))
english_survey <-
  read_csv(file = here::here("data/2019 English R Community Survey Responses.csv"),
           col_types = column_formats, col_names = english_column_names$Question_name, skip = 1)
names(english_survey) <- english_column_names$Question_name
english_survey$language <- "English"
spanish_survey <-
  read_csv(here::here("data/2019 Spanish R Community Survey Responses.csv"),
           col_types = column_formats, col_names = english_column_names$Question_name, skip = 1)
names(spanish_survey) <- english_column_names$Question_name
spanish_survey$language <- "Spanish"

survey_raw <- rbind(english_survey, spanish_survey)
survey_questions <-
  read_csv(here::here("data/survey-questions-2019-en.csv"))
# Saving some metadata for later
respondents_raw <- nrow(survey_raw)
survey <- survey_raw %>%
  mutate(robot_test = str_to_lower(Qrobot_test)) %>%
  filter(!is.na(robot_test)) %>% 
  filter(robot_test == "8" | robot_test == "eight" | robot_test == "ocho")
respondents <- nrow(survey)
survey_save <- survey

```

```{r survey pre-processing, include=FALSE, eval = FALSE}
# this section is eval = FALSE because most users will want to use the 
# processed version of the survey, survey_{language}.tsv in # the data/ directory of the repo.
# This chunk is used only to create that file.

survey <- survey_save   # This is just to ensure I get the original survey each time I run this block.

# Make the times correct times
est <- locale(tz="US/Eastern")
survey$Qtime <- parse_datetime(as.character(survey$Qtime), format = "%m/%d/%Y %H:%M:%S", locale=est)

# This learner_type variable defines if someone is a recent R learner or not for faceting
survey <- survey %>% 
  mutate(learner_type = ifelse(Qr_year < 1900, NA, ifelse(Qr_year <= 2016, "Early Learner", "Recent Learner")))

# This codes the open-text gender question into a more friendly form for analysis
survey$Qgender <- survey$Qgender %>% tolower() %>% str_trim() %>% str_replace_all("[[:punct:]]", "")

opentext_gender_dictionary <- read_csv("dictionary/opentext_gender_dictionary.csv")
gender_dictionary <- opentext_gender_dictionary %>%  mutate(Input = str_replace_all(Input, "[[:punct:]]", ""))
# The following is weird -- its a function within the gendercodeR package that should be exported, but doesn't seem to
# show up. you can fix that by sourcing the function definition as follows:
    source("gendercoder/R/genderCode.R")

survey <- genderRecode(survey, method = "narrow", 
                       genderColName = "Qgender",
                       outputColName = "Qgender_coded",
                       customDictionary = gender_dictionary)
survey <- survey %>% mutate(Qgender_coded = ifelse(Qgender_coded == "", NA, Qgender_coded))
uncoded_genders <- survey %>% group_by(Qgender_coded) %>% count(sort = TRUE)
write_csv(uncoded_genders, "data/uncoded_genders_language.csv")  # For detecting open ends we should code

# This codes the ethnicity question for further analysis
# We recognize that this is both an offensive question to some and an imperfect classification
# Its purpose is to simply measure how diverse our community is. Our rationale is that if
# we do not attempt to measure the R community's diversity, then our claims of community diversity
# are meaningless because our only measurements are anecdotal.

opentext_ethnicity_dictionary <- read_csv("dictionary/opentext_ethnicity_dictionary.csv")
ethnicity_dictionary <- opentext_ethnicity_dictionary %>%  
  mutate(Input = str_replace_all(Input, "[[:punct:]]", ""))

# Yes, I know this will cause false categorizations of open-ended responses with commas as Multiple Ethnicities
# That said, I can't see an obvious other way to detect multiple ethnicities beyond the dictionary matches below

survey <- survey %>% 
  mutate(Qethnicity_processed = ifelse(str_detect(Qethnicity, ","), "Multiple Ethnicities", Qethnicity))
survey$Qethnicity_processed <- survey$Qethnicity_processed %>% tolower() %>% str_trim() %>% str_replace_all("[[:punct:]]", "")
survey <- survey %>% 
  left_join(ethnicity_dictionary, by=c("Qethnicity_processed" = "Input"))
uncoded_ethnicities <- survey %>% 
  anti_join(ethnicity_dictionary, by=c("Qethnicity_processed" = "Input")) %>% 
  count(Qethnicity_processed, sort = TRUE) 
write_csv(uncoded_ethnicities, "dictionary/uncoded_ethnicities_language.csv")  # For detecting open ends we should code

# Qethnicity_coded got created by the left_join above.....

survey <- survey %>% 
  mutate(Qethnicity_coded = ifelse(Qethnicity_coded == "Prefer not to answer",
                                   NA, 
                                   Qethnicity_coded))
collected_ethnicities <- survey %>% group_by(Qethnicity_coded) %>% count(sort = TRUE)

## Let's save the survey data at this point with the question names, 
## augmented gender and ethnicity coding
## so that others don't have to go through this hassle.
survey$number_responses <- nrow(survey)
write_delim(survey, here::here("data/", paste0("survey_", params$language,".tsv")), delim="\t")
theme_set(theme_classic())

```



## Responses over time

```{r responses over time, include = FALSE}
theme_set(theme_classic())
survey <- survey %>% mutate(Qtime = parse_datetime(survey$Qtime, format="%m/%d/%Y %H:%M:%S")) %>% arrange(Qtime)
survey <- survey %>% mutate(number_responses = cumsum(!is.na(Qtime)))
p <- ggplot(survey) + 
  geom_line(aes(x=Qtime, y=number_responses)) + 
  ggtitle(sprintf("%s Survey Responses Over Time (N = %d)",params$language, respondents)) + 
  labs(y = "Time", x = "Response Date")
print(p)
```

# Demographics

## Respondent Ages  (All Respondents)

```{r Respondent Ages, echo = TRUE}
mean_age <- mean(2019 - survey$Qyear_born, na.rm = TRUE)

ggplot(survey) +
  geom_histogram(aes(2018 - Qyear_born), binwidth = 1,  fill = params$bar_colors, color="white") +
  geom_vline(aes(xintercept = mean_age), color = "lightblue") +
  annotate("text", x = 41, y = 150, label = paste0("Mean age = ", round(mean_age, 0))) +
  scale_x_continuous(breaks = seq(15,80,5), limits = c(15, 80)) +
  labs(subtitle = "Respondent Ages (Respondent counts shown, All respondents)", x="Age", y="Count") +
  theme(panel.background = element_rect(fill = "transparent",colour = NA),
        plot.background = element_rect(fill = "transparent",colour = NA))
plot_save("Respondent Ages (All Respondents).pdf", height = 3)
```

## Respondent Gender  (All Respondents)

```{r Respondent Gender, echo = TRUE}

genders <- survey %>% 
  group_by(Qgender_coded) %>% 
  count(sort = TRUE) %>% 
  mutate(unit = 1) %>% 
  drop_na()

# genders <- survey %>% 
#   group_by(Qgender) %>% 
#   count(sort = TRUE) %>% 
#   mutate(unit = 1) %>% 
#   drop_na()

gender_responses <- sum(genders$n, na.rm = TRUE)
genders <- genders %>% 
  group_by(unit) %>% 
         mutate(percent = round(n / gender_responses * 100),
                prop_responses = n / gender_responses,
         position = cumsum(percent) - percent / 2,
         label = ifelse(percent >= 10, paste0(Qgender_coded, "\n", round(percent), "%"), "")) %>% 
  arrange(desc(percent))
genders <- genders %>% 
  mutate(Qgender_coded = factor(as.character(Qgender_coded), levels = rev(c("male", "female", "sex and gender diverse", "unclear")))) %>% 
  drop_na()

lollipop_chart(df                 = genders,
          column_name        = Qgender_coded,
          subtitle_string    = question_text("Qgender", "(All respondents)"),
          title_string       = "",
          fill_color         = params$bar_colors,
          caption_string     = paste0(survey_name, ", n = ",gender_responses))
plot_save("Respondent Identified Genders (All Respondents).pdf", height = 2)
```


## Respondent Countries  (All Respondents)

```{r Respondent Countries, echo = TRUE}
countries <- survey %>% count(Qcountry, sort=TRUE) %>% drop_na()
names(countries) <- c("region", "value")
countries <- countries %>% mutate(region = tolower(region))
unknown_countries <- c("singapore", "korea", "south", "serbia and montenegro", "hong kong", "andorra", "bahrain", "christmas island", "macau", "mauritius", "puerto rico", "tanzania")
choro_countries <- countries %>% filter(!(region %in% unknown_countries))
choro_countries <- choro_countries %>% mutate(region = str_replace_all(region, "korea, south", "south korea"))

# country_choropleth(choro_countries, title = "", legend = "", num_colors = 8,
#  zoom = NULL)

plot_countries <- country.map %>% left_join(choro_countries, by = "region")
ggplot(data = plot_countries, aes(long, lat, group=group)) + 
  geom_polygon(aes(fill = value), na.value = "gray80", color = "gray", size=0.1) +
  scale_fill_gradient(trans = "log10", low = "dark blue", high = "yellow") +
  coord_fixed(1.3) +
  scale_x_continuous(breaks = seq(-150, 150, 60)) +
  scale_y_continuous(breaks = seq(-60, 90, 30), limits = c(-60, 90)) +
  theme(axis.line = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "transparent",colour = NA),
        plot.background = element_rect(fill = "transparent",colour = NA)
  ) +
  labs(subtitle = question_text("Qcountry"),
       caption = survey_name,
       x = "", y = "", fill = "Responses")
  plot_save("Respondent Countries (All Respondents).pdf")
```

## Industry  (All Respondents)

```{r Respondent industry, echo = TRUE}
r_industry_dictionary <- read_delim("dictionary/industry_dictionary.tsv", delim = "\t", col_types = "cc")
r_industry <- survey %>% select(Qindustry) %>% 
  drop_na() %>% 
  left_join(r_industry_dictionary, c("Qindustry" = "Input"))
r_industry_exceptions <- survey %>% select(Qindustry) %>% 
  drop_na() %>% 
  anti_join(r_industry_dictionary, c("Qindustry" = "Input"))
r_industry_results <- tally_question(r_industry, Output, rm.na = TRUE, sort = TRUE)
r_industry_responses <- first(r_industry_results$nn)
r_industry_results <- r_industry_results %>% select(- nn)

# industry <- survey %>% count(Qindustry, sort = TRUE)
# industry_responses <- sum(!is.na(survey$Qindustry))
# industry <- industry %>% mutate(percent = round(n / industry_responses * 100, 1))

top_10_industries <- top_n_choices(r_industry_results, Output, r_industry_responses, 10)

top_10_industries <- top_10_industries %>% 
  mutate(Qindustry = factor(Output, levels = rev(Output)),
         position = cumsum(percent) - percent / 2,
         label = ifelse(percent >= 5, paste0(Output, "\n", round(percent / 100), "%"), ""),
         percent = percent / 100)

lollipop_chart(df          = top_10_industries,
          column_name            = Qindustry,
          subtitle_string        = question_text("Qindustry", "(All respondents)"),
          fill_color             = params$bar_colors,
          caption_string         = paste0(survey_name, ", n = ",r_industry_responses))
plot_save("Respondent Industries (All Respondents).pdf", height = 3)
```

## Ethnicity  (All Respondents)

```{r Ethnicity, echo = TRUE}
# Multiple categories selected will be separated by commas, so we'll count those as multiple ethnicities
# This will probably miscategorize some open ends, but a quick analysis showed we have very few open ends
# with embedded commas.

ethnicities <-survey %>% group_by(Qethnicity_coded) %>% count(sort = TRUE)
num_ethnicity_responses <- sum(!is.na(survey$Qethnicity_coded))
ethnicities <- ethnicities %>% 
  mutate(percent = round(n / num_ethnicity_responses * 100, 1),
         prop_responses = n / num_ethnicity_responses) %>%
  ungroup() %>% 
  drop_na() %>% 
  arrange(desc(percent))

ethnicities <- ethnicities %>% 
 mutate(unit = 1,
        Qethnicity_coded = factor(as.character(Qethnicity_coded), levels = Qethnicity_coded),
        position = cumsum(percent) - percent / 2,
        x_position = cumsum(unit) %% 3 * 0.06 + (1 - 0.06),
        label = ifelse(percent >= 2, paste0(Qethnicity_coded, "\n", round(percent), "%"), ""))

## Another customized pie chart here to use repelled labels to show small minority groups

lollipop_chart(ethnicities,
               Qethnicity_coded,
               fill_color = params$bar_colors,
               subtitle_string =  question_text("Qethnicity", "(All respondents)"),
               caption_string = paste0(survey_name, ", n = ", num_ethnicity_responses))
plot_save("Respondent Ethnicities (All Respondents).pdf", height = 2.5)
  
```

## Education Level  (All Respondents)

```{r Education level, echo = TRUE}

r_education_dictionary <- read_delim("dictionary/education-dictionary.tsv", delim = "\t", col_types = "cc")
r_education <- survey %>% select(Qdegree) %>% 
  drop_na() %>% 
  left_join(r_education_dictionary, c("Qdegree" = "Input"))
r_education_exceptions <- survey %>% select(Qdegree) %>% 
  drop_na() %>% 
  anti_join(r_education_dictionary, c("Qdegree" = "Input"))
r_education_results <- tally_question(r_education, Output, rm.na = TRUE, sort = TRUE)
r_education_responses <- first(r_education_results$nn)

r_education_results <- r_education_results %>% 
 mutate(Output = factor(Output, levels = rev(Output)),
         position = cumsum(percent) - percent / 2,
         label = ifelse(percent >= 2, paste0(Output, "\n", round(percent), "%"), ""))

lollipop_chart(df                     = r_education_results,
          column_name            = Output,
          fill_color             = params$bar_colors,
          subtitle_string        = question_text("Qdegree", "(All respondents)", 70),
          caption_string         = paste0(survey_name, ", n = ", r_education_responses)
)
plot_save("Respondent Education (All Respondents).pdf")
```

## Job Title  (All Respondents)

```{r Job title, echo = TRUE}
job_title_dictionary <- read_delim("dictionary/work-title-dictionary.tsv", delim = "\t", col_types = "cc")
job_titles <- survey %>% select(Qwork_title) %>% 
  drop_na() %>% 
  left_join(job_title_dictionary, c("Qwork_title" = "Input"))
job_title_exceptions <- survey %>% select(Qwork_title) %>% 
  drop_na() %>% 
  anti_join(job_title_dictionary, c("Qwork_title" = "Input"))

job_title_totals <- job_titles %>% count(Output, sort = TRUE)
job_title_responses <- sum(!is.na(survey$Qwork_title))
job_titles <- job_title_totals %>% mutate(percent = round(n / job_title_responses * 100, 0))

top_10_titles <- top_n_choices(job_titles, Output, job_title_responses, 10)

top_10_titles <- top_10_titles %>% 
  mutate(JobTitle = factor(Output, levels = rev(Output)),
         position = cumsum(percent) - percent / 2,
         label = ifelse(percent >= 5, paste0(JobTitle, "\n", round(percent), "%"), ""))

lollipop_chart (df = top_10_titles,
          column_name = JobTitle,
          fill_color = params$bar_colors,
          subtitle_string        = question_text("Qwork_title", "(All respondents)"),
          caption_string         = paste0("RStudio Learning R Survey, n = ",job_title_responses))
plot_save("Respondent Job Titles (All Respondents).pdf")
```

## Tools Used Prior To R (All Respondents)

```{r Tools Used Prior To Learning R, echo = TRUE}

languages <- survey %>% select(Qlanguages)
num_language_responses <- sum(!is.na(languages$Qlanguages))
languages_used <- split_and_aggregate(languages, Qlanguages)
languages_used <- languages_used %>% 
  select(-num_responses) %>% 
  mutate(percent = round(n / num_language_responses * 100))
top_10_items <- top_n_choices(languages_used, items, num_language_responses, 10)
top_10_items <- top_10_items %>%
  mutate(items = factor(items, levels = rev(items)))

lollipop_chart(top_10_items, 
          column_name = items, 
          fill_color = params$bar_colors, 
          subtitle_string = question_text("Qlanguages", "(All respondents)", 70),
          caption_string = paste0(survey_name, ", n = ", num_language_responses))
plot_save("What Languages Do You Use Besides R (All Respondents).pdf")
```

## First Language Learned (All Respondents)

```{r First Language or Tool Learned, echo = TRUE}

fl <- survey %>%
  transmute(Input = tolower(Qfirst_language),
            Output = Qfirst_language)

fl <- fl %>% mutate(Output = ifelse(str_detect(Input, "basic"), "Basic", Output),
                    Output = ifelse(str_detect(Input, "fortran"), "Fortran", Output),
                    Output = ifelse(str_detect(Input, "cobol"), "Cobol", Output),
                    Output = ifelse(str_detect(Input, "algol"), "Algol", Output),
                    Output = ifelse(str_detect(Input, "sql"), "SQL", Output),
                    Output = ifelse(str_detect(Input, "html"), "HTML", Output),
                    Output = ifelse(str_detect(Input, "pascal"), "Pascal", Output),
                    Output = ifelse(str_detect(Input, "stata"), "Stata", Output),
                    Output = ifelse(str_detect(Input, "dbase"), "DBase", Output),
                    Output = ifelse(str_detect(Input, "just getting started"), "Just starting programming", Output),
                    Output = ifelse(str_detect(Input, "bash"), "Bash", Output))

# Honestly, the rest of the answers aren't significant, but you can check using the following
# write_delim(fl_tallies, "dictionary/first-language-dictionary.tsv", delim="\t")
                   
fl_tallies <- fl %>% count(Output, sort = TRUE)
num_first_language_responses <- sum(!is.na(fl$Output))
top_10_languages <- top_n_choices(fl_tallies, Output, num_first_language_responses, 10) %>% 
  mutate(Output = factor(Output, levels = rev(Output)))

lollipop_chart(top_10_languages, 
          column_name = Output, 
          fill_color = params$bar_colors, 
          subtitle_string = question_text("Qfirst_language", "(All respondents)", 65),
          caption_string = paste0(survey_name, ", n = ", num_first_language_responses))
plot_save("What Language Did You FIRST Learn (All Respondents).pdf")

```

## Age When Respondents Learned R (All Respondents)

```{r Age when respondents learned R, echo = TRUE}

r_ages <- survey %>% select(Qr_year, Qyear_born) %>% filter(Qr_year >= 1990 & Qyear_born >= 1900) %>% mutate(age_learned_r = Qr_year - Qyear_born)
mean_age_learned_r <- mean(r_ages$age_learned_r, na.rm = TRUE)
median_age_learned_r <- round(median(r_ages$age_learned_r, na.rm = TRUE))
r_year_responses <- sum(!is.na(r_ages$age_learned_r))
r_year_tally <- tally_question(r_ages, age_learned_r)

ggplot(r_ages) +
  geom_histogram(aes(x = age_learned_r), binwidth = 1,  fill = params$bar_colors, color="white") +
  geom_vline(aes(xintercept = mean_age_learned_r), color = "lightblue") +
  annotate("text", x = mean_age_learned_r + 8, y = 150, label = paste0("Mean age = ", round(mean_age_learned_r, 0))) +
  scale_x_continuous(breaks = seq(15,80,5), limits = c(15, 80)) +
  labs(title = "Ages When Respondents Started Learning R (All Respondents)", x="Age", y="Count") +
  theme(panel.background = element_rect(fill = "transparent",colour = NA),
        plot.background = element_rect(fill = "transparent",colour = NA))
plot_save("Ages When Respondents Learned R.pdf", height = 3)
```

## Number of People You Work With That Know R By Learner Type

This plot is currently disabled

```{r Number R Team Members, echo = TRUE, eval = FALSE}
team_num_survey <- survey %>% 
  select(learner_type, Qteam_r_users) %>% 
  filter(!is.na(learner_type)) %>% 
  filter(Qteam_r_users <= 1000)
mean_team_sizes <- team_num_survey %>% 
  group_by(learner_type) %>% 
  summarize(mean_team_size = round(mean(Qteam_r_users, na.rm = TRUE)))

library(ggbeeswarm)
ggplot(team_num_survey, aes(x = learner_type, y = Qteam_r_users, group = learner_type)) +
  geom_quasirandom(aes(color = learner_type), varwidth = TRUE, alpha = 0.1, method = "pseudorandom") +
  geom_violin(aes(color = learner_type), width = 0.5, fill = NA) +
  geom_text(data = mean_team_sizes,
            aes(x = learner_type, 
                y = 0.75, 
                label = sprintf("Mean team size = %d", mean_team_size)),
            fill = "white") +
    scale_y_continuous(trans = "log10") +
  scale_color_brewer(palette = "Dark2") +
  labs(subtitle = question_text("Qteam_r_users", "(R users only)", 75),
       caption = survey_name,
       x="Learner Type", y="# Team Members", color = "Learner Type")
plot_save("R Team Size Distribution by Learner Type.pdf")

  
```


## Respondent Ages By Learner Type

This plot is currently disabled

```{r R Learning Ages By Learner Type, echo = TRUE, eval = FALSE}

ages <- survey %>%
  filter(!is.na(learner_type) & Qyear_born < 2010) %>% 
  mutate(age = 2018 - Qyear_born)

mean_ages <- ages %>% 
  group_by(learner_type) %>% 
  summarize(mean_age = mean(age, na.rm = TRUE))

ggplot(ages, aes(x = learner_type, y = age, group = learner_type)) +
  geom_violin(aes(color = learner_type), width = 0.5) +
  geom_jitter(aes(color = learner_type), alpha = 0.1, width = 0.02) +
  scale_y_continuous(breaks = seq(15,90,5)) +
  scale_color_brewer(palette = "Dark2") +
  labs(title = "Respondent Age",
       subtitle = sprintf("Early Learner Mean Age = %d, Recent Learner = %d", 
                          round(mean_ages$mean_age[1]), round(mean_ages$mean_age[2])),
       caption = survey_name,
       x="Learner Type", y="Age", color = "Learner Type")
  plot_save("Respondent Age By Learner Type.pdf")
```

## Year Respondents Learned R (All Respondents)

```{r Year respondents learned R, echo = TRUE}

r_years <- survey %>% select(Qr_year) %>% filter(Qr_year >= 1990) %>% mutate(r_age = 2018 - Qr_year)
mean_r_year <- mean(r_years$Qr_year, na.rm = TRUE)
median_r_year <- round(median(r_years$Qr_year, na.rm = TRUE))
r_year_responses <- sum(!is.na(r_years$Qr_year))
r_year_tally <- tally_question(r_years, Qr_year)

ggplot(r_years) +
  geom_histogram(aes(Qr_year), binwidth = 1, fill = params$bar_colors, color="white") +
  geom_vline(aes(xintercept = round(mean_r_year)), color = "lightblue") +
  annotate("text", x = mean_r_year-2.7, y = 400, label = paste0("Mean = ", round(mean_r_year, 0))) +
  scale_x_continuous(breaks = c(1990, 1995, 2000, 2005, 2010, 2015, 2018)) +
  labs(title = "", 
       subtitle = question_text("Qr_year"),
       caption = paste0(survey_name, ", n = ", r_year_responses),
       x="Year", y="Count")
  plot_save("Year Learned R.pdf")
```

# Learning Questions

## R Difficulty (R Users Only)

```{r Difficulty Learning R Experienced, echo = TRUE}

r_difficulty <- tally_question(survey, Qr_difficulty_experienced, rm.na = TRUE, sort = FALSE)
diff_responses <- first(r_difficulty$nn)
mean_difficulty = round(mean(survey$Qr_difficulty_experienced, na.rm = TRUE), 1)

r_difficulty <- r_difficulty %>%
  mutate(percent = percent / 100)      # the plot below uses a percent y axis

ggplot(r_difficulty) +
  geom_bar(aes(x = Qr_difficulty_experienced, y = percent),
           stat = "identity",
           color = params$bar_colors,
           fill = params$bar_colors,
           width = 0.5,
           alpha = 0.5) +
  geom_text(aes(x = Qr_difficulty_experienced, y = percent,
                label = paste0(round(percent * 100), "%")),
                color = "gray30",
                nudge_y = .03) +
  geom_vline(aes(xintercept = mean_difficulty), color = "darkblue") +
  annotate("text", x = 2.2, y = 0.4, label = paste0("Mean value = ", mean_difficulty)) +
  scale_y_continuous(labels = scales::percent) +
  labs(title = "Difficulty in Learning R (R Users Only)", 
       subtitle = question_text("Qr_difficulty_experienced", 72),
       caption = paste0(survey_name, ", n = ", diff_responses),
       x="Respondent Rating (1 = Easiest, 5 = Most Difficult)", y="")
  plot_save("Difficulty in Learning R (R Users Only).pdf")
```

## Time To R Proficiency (R Users Only)

```{r Time to proficiency, echo = TRUE}
r_proficiency_dictionary <- read_delim("dictionary/r_proficiency_dictionary.tsv", delim = "\t", col_types = "cc")
r_proficiency <- survey %>% select(Qtime_to_proficiency) %>% 
  drop_na() %>% 
  left_join(r_proficiency_dictionary, c("Qtime_to_proficiency" = "Input"))
r_proficiency_exceptions <- survey %>% select(Qtime_to_proficiency) %>% 
  drop_na() %>% 
  anti_join(r_proficiency_dictionary, c("Qtime_to_proficiency" = "Input"))
r_proficiency_results <- tally_question(r_proficiency, Output, rm.na = TRUE, sort = TRUE)
r_proficiency_responses <- first(r_proficiency_results$nn)
r_proficiency_results <- r_proficiency_results %>% 
  mutate(Output = factor(Output, levels = rev(Output)),
         position = cumsum(percent) - percent / 2,
         label = ifelse(percent >= 10, paste0(Output, "\n", round(percent), "%"), ""))

lollipop_chart(df                 = r_proficiency_results,
          column_name        = Output,
          subtitle_string        = question_text("Qtime_to_proficiency", "(R users only)", 70),
          caption_string         = paste0(survey_name, ", n = ",r_proficiency_responses),
          fill_color             = params$bar_colors)

plot_save("Time To Achieve Proficiency In R (R Users Only).pdf", height = 3)



```

## Reason Why Learned R (R Users Only)

```{r Why Learned R, echo = TRUE}

r_why_dictionary <- read_delim("dictionary/r_why_dictionary.tsv", delim = "\t", col_types = "cc")
r_why_responses <- survey %>% 
  mutate(why = as.character(Qreason_experienced)) %>% 
  select(why)
r_why <- r_why_responses %>% 
  drop_na() %>% 
  left_join(r_why_dictionary, c("why" = "Input"))
r_why_exceptions <- r_why_responses %>% 
  drop_na() %>% 
  anti_join(r_why_dictionary, c("why" = "Input"))
r_why_results <- tally_question(r_why, Output, rm.na = TRUE, sort = TRUE)
r_why_n <- first(r_why_results$nn)
r_why_results <- r_why_results %>% mutate(Output = str_wrap(Output, 40))
r_why_results <- r_why_results %>% 
  mutate(Output = factor(Output, levels = rev(Output)),
         position = cumsum(percent) - percent / 2,
         label = ifelse(percent >= 10, paste0(Output, "\n", round(percent), "%"), ""))


lollipop_chart(df                 = r_why_results,
          column_name             = Output,
          subtitle_string         = question_text("Qr_reason_experienced", "(R Users Only)", 75),
          caption_string          = paste0("RStudio Learning R Survey, n = ",r_why_n),
          fill_color              = params$bar_colors)
plot_save("Reason To Learn R (R Users Only).pdf")

```

## What is Your Experience with R? (All Respondents)

```{r R Experience so far, echo = TRUE}
r_experience_dictionary <- read_delim("dictionary/r_experience_dictionary.tsv", delim = "\t", col_types = "cc")
r_experience <- survey %>% select(Qr_experience) %>% 
  drop_na() %>% 
  left_join(r_experience_dictionary, c("Qr_experience" = "Input"))
r_experience_exceptions <- survey %>% select(Qr_experience) %>% 
  drop_na() %>% 
  anti_join(r_experience_dictionary, c("Qr_experience" = "Input"))
r_experience_results <- tally_question(r_experience, Output, rm.na = TRUE, sort = TRUE)
r_experience_responses <- first(r_experience_results$nn)
r_experience_results <- r_experience_results %>% 
  mutate(Output = factor(Output, levels = rev(Output)),
         position = cumsum(percent) - percent / 2,
         label = ifelse(percent >= 10, paste0(Output, "\n", round(percent), "%"), ""))
r_experience <- r_experience_results %>% 
  mutate(Output = factor(Output, levels = rev(Output)))

r_experience_responses <- first(r_experience$nn)
r_experience <- r_experience %>% 
 mutate(Output = factor(Output, levels = Output),
         position = cumsum(percent) - percent / 2,
         label = ifelse(percent >= 2, paste0(Output, "\n", round(percent), "%"), ""))

lollipop_chart(df                 = r_experience,
          column_name        = Output,
          subtitle_string        = question_text("Qr_experience", "(All respondents)"),
          caption_string         = paste0("RStudio Learning R Survey, n = ",r_experience_responses),
          fill_color                 = params$bar_colors)
plot_save("R Experience (All Respondents).pdf", height = 2)

```

## How Did You Learn R  (R Users Only)

```{r How Did You Learn R, echo = TRUE}
# We shorten down the given answers while categorizing open-text answers given for "Other"
# Just as we did for the gender and industry questions, we use small dictionary to do this
# However, because commas may appear in the open text respones, we'll use a tsv file instead of a csv one.

r_path_dictionary <- read_delim("dictionary/r-path-dictionary.tsv", delim = "\t", col_types = "cc")
r_paths <- survey %>% select(Qr_learning_path) %>% left_join(r_path_dictionary, c("Qr_learning_path" = "Input"))
r_path_exceptions <- survey %>% select(Qr_learning_path) %>% 
  drop_na() %>% 
  anti_join(r_path_dictionary, c("Qr_learning_path" = "Input"))

r_path_results <- tally_question(r_paths, Output, rm.na = TRUE, sort = TRUE)
# answer_table <- r_paths %>% select(Qr_learning_path, n)
# write_delim(answer_table, "dictionary/r-path-dictionary.tsv", delim="\t")
r_path_responses <- first(r_path_results$nn)

r_path_results <- r_path_results %>% 
 mutate(Output = factor(Output, levels = Output),
         position = cumsum(percent) - percent / 2,
         label = ifelse(percent >= 2, paste0(Output, "\n", round(percent), "%"), ""))

lollipop_chart(df                 = r_path_results,
          column_name            = Output,
          subtitle_string        = question_text("Qr_learning_path", "(R users only)"),
          caption_string         = paste0(survey_name, ", n = ", r_path_responses),
          fill_color                 = params$bar_colors)
plot_save("R Learning Path  (R Users Only).pdf", height = 3)

```



## Difficulty of Learning R based on Learner Type

```{r Ages By Learner Type, echo = TRUE}

ss <- survey %>% filter(!is.na(learner_type) & !is.na(Qr_difficulty_experienced))
ss_grouped <- ss %>% 
  group_by(learner_type, Qr_difficulty_experienced) %>% 
  count(Qr_difficulty_experienced)

ggplot(ss) +
  geom_bar(aes(x = Qr_difficulty_experienced, y = ..prop.., fill = learner_type, group = learner_type),
           position = position_dodge(width = 0.5),
           alpha = 0.5) +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_brewer(palette = "Set1") +
  labs(subtitle = question_text("Qr_difficulty_experienced", "(R users only)", 80),
       caption = survey_name,
       x="Respondent Rating (1 = Extremely Easy, 5 = Extremely Difficult)", y="", fill = "Learner Type")
  plot_save("Learning R Difficulty by Learner Type.pdf")
```

## What is R Used For?  (R Users Only)

```{r R Used For, echo = TRUE}
r_use_dictionary <- read_delim("dictionary/use_dictionary.tsv", delim = "\t", col_types = "cc")

# Breaks up uses into nested lists
uses <- survey %>% mutate(application = purrr::map(Qused_for, str_split, ", ")) %>% unnest()
apps_used <- uses %>% unnest() %>% select(application)
parsed_use_used <- apps_used %>% 
  left_join(r_use_dictionary, c("application" = "Input"))
parsed_use_exceptions <- apps_used %>% 
  anti_join(r_use_dictionary, c("application" = "Input"))
# Count the non-NA entries now
use_responses <- sum(!is.na(survey$Qused_for))

parsed_use_tally <- parsed_use_used %>% count(Output, sort = TRUE)

parsed_use_tally <- parsed_use_tally %>% 
  mutate(percent = round(n / use_responses * 100),
         prop_responses = n / use_responses) %>% 
  arrange(desc(percent))
app_plot <- head(parsed_use_tally, 15) %>% 
  ungroup() %>% 
  arrange(prop_responses)

other <- tail(parsed_use_tally, -15) %>% 
  ungroup() %>% 
  summarize(Output = "Other", 
            n = sum(n), 
            percent = round(n / use_responses * 100),
            prop_responses = n / use_responses)

app_plot <- rbind(other, app_plot) %>% drop_na()
app_plot <- app_plot %>% 
  mutate(Output = factor(as.character(Output), levels = Output))

lollipop_chart_100pc(app_plot, 
               Output, 
               fill_color = params$bar_colors,
               subtitle_string =  question_text("Qused_for", "", 75),
               caption = paste0(survey_name, ", n = ", use_responses))
plot_save("What Do You Use R For (R Users Only).pdf")
plot_save("What Do You Use R For.jpg")

```

## What is Python Used For?

```{r Python Used For, echo = TRUE}
python_use_dictionary <- read_delim("dictionary/use_dictionary.tsv", delim = "\t", col_types = "cc")

# Breaks up uses into nested lists
uses <- survey %>% mutate(application = purrr::map(Qpython_apps, str_split, ", ")) %>% unnest(cols = c(application))
apps_used <- uses %>% unnest(cols = c(application)) %>% select(application)
parsed_use_used <- apps_used %>% 
  left_join(python_use_dictionary, c("application" = "Input"))
parsed_use_exceptions <- apps_used %>% 
  anti_join(python_use_dictionary, c("application" = "Input"))
# Count the non-NA entries now
use_responses <- sum(!is.na(survey$Qpython_apps))

parsed_use_tally <- parsed_use_used %>% count(Output, sort = TRUE)

parsed_use_tally <- parsed_use_tally %>% 
  mutate(percent = round(n / use_responses * 100),
         prop_responses = n / use_responses) %>% 
  arrange(desc(percent))
app_plot <- head(parsed_use_tally, 15) %>% 
  ungroup() %>% 
  arrange(prop_responses)

other <- tail(parsed_use_tally, -15) %>% 
  ungroup() %>% 
  summarize(Output = "Other", 
            n = sum(n), 
            percent = round(n / use_responses * 100),
            prop_responses = n / use_responses)

app_plot <- rbind(other, app_plot) %>% drop_na()
app_plot <- app_plot %>% 
  mutate(Output = factor(as.character(Output), levels = Output))

lollipop_chart_100pc(app_plot, 
               Output, 
               fill_color = params$bar_colors,
               subtitle_string =  question_text("Qpython_apps", "", 75),
#               subtitle_string =  "What do you use Python for most?",
               caption = paste0(survey_name, ", n = ", use_responses))
plot_save("What Do You Use Python For.pdf")
plot_save("What Do You Use Python For.jpg")

```

## Net Promoter Score  (R Users Only)

```{r Net Promoter Score, echo = TRUE}

recommend_totals <-survey %>% group_by(Qrecommend) %>% tally()
responses <- sum(!is.na(survey$Qrecommend))
recommend_totals <- recommend_totals %>% mutate(percent = n / responses * 100)
recommend_scores <- tibble(Qrecommend = 1:10) %>% left_join(recommend_totals, by = "Qrecommend")
nps <- round(sum(recommend_scores$percent[9:10], na.rm=TRUE) - 
               sum(recommend_scores$percent[1:6], na.rm=TRUE))  # Standard NPS formula (see Wikipedia)
npr <- nps %>% cut(breaks = c(-100, 0, 50, 75, 100), labels = c("Dangerous", "Good", "Excellent", "World Class"))

ggplot(recommend_scores) +
  geom_col(aes(x = Qrecommend, y = percent), fill = params$bar_colors) +
  geom_text(aes(x = Qrecommend, y = percent, label = paste0(round(percent), "%")), 
            color="black", size=3, nudge_y = 3) +
  scale_x_continuous(breaks = 1:10) +
    labs(title = question_text("Qrecommend", "(R users only)", 35),
       subtitle = sprintf("Net Promoter Score = %s,        Rating: %s", nps, npr),
       caption = paste0(survey_name, " (R Users Only), n = ", responses),
       x="Score", y="") +
  theme(panel.background = element_rect(fill = "transparent",colour = NA),
        plot.background = element_rect(fill = "transparent",colour = NA),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())

plot_save("Net Promoter Score.pdf")
```

# Tools

## What Tools Do You Use With R?  (R Users Only)

```{r R Tools Used, echo = TRUE}

uses <- survey %>% transmute(tools = str_replace_all(Qtools_with_r, "i.e., ", ""))
num_tool_responses <- sum(!is.na(survey$Qtools_with_r))
tools_used <- split_and_aggregate(uses, tools)
tools_used <- tools_used %>% 
  select(-num_responses) %>% 
  mutate(percent = round(n / num_tool_responses * 100))
top_15_items <- top_n_choices(tools_used, items, num_tool_responses, 15) %>% arrange(percent)
top_15_items <- top_15_items %>%
  mutate(items = factor(as.character(items), levels = items))

lollipop_chart(top_15_items, 
          column_name = items, 
          fill_color = params$bar_colors, 
          subtitle_string = question_text("Qtools_with_r", "(R users only)", 60),
          caption_string = paste0(survey_name, ", n = ", num_tool_responses))
plot_save("What Tools Do You Use With R (R Users Only).pdf")
```


## Frequency of R Use (R Users Only)

```{r Frequency of R Use, echo = TRUE}

use_dictionary <- read_delim("dictionary/frequency_of_use_dictionary.tsv", delim = "\t", col_types = "cc")

r_use_responses <- survey %>% select(Qr_how_often_used)
r_use_parsed <- r_use_responses %>% 
   left_join(use_dictionary, c("Qr_how_often_used" = "Input"))
r_use_exceptions <- r_use_responses %>% 
  anti_join(use_dictionary, c("Qr_how_often_used" = "Input"))
r_use_results <- tally_question(r_use_parsed, Output, rm.na = TRUE, sort = TRUE)
# answer_table <- r_paths %>% select(Qr_learning_path, n)
# write_delim(answer_table, "dictionary/r-path-dictionary.tsv", delim="\t")
r_use_responses <- first(r_use_results$nn)

r_use_results <- r_use_results %>% 
 mutate(Output = factor(Output, levels = rev(Output)),
         position = cumsum(percent) - percent / 2,
         label = ifelse(percent >= 2, paste0(Output, "\n", round(percent), "%"), ""))

lollipop_chart(df                 = r_use_results,
          column_name        = Output,
          subtitle_string        = question_text("Qr_how_often_used", "(R users only)"),
          caption_string         = paste0(survey_name, ", n = ", r_use_responses),
          fill_color             = params$bar_colors)
plot_save("Frequency of R Use (R Users Only).pdf")


```

## R Enjoyment (R Users Only)

```{r R Enjoyment, echo = TRUE}

r_enjoyment <- tally_question(survey, Qr_enjoyment, rm.na = TRUE, sort = FALSE)
diff_responses <- first(r_enjoyment$nn)
mean_enjoyment = round(mean(survey$Qr_enjoyment, na.rm = TRUE), 1)

r_enjoyment <- r_enjoyment %>%
  mutate(percent = percent / 100)      # the plot below uses a percent y axis

ggplot(r_enjoyment) +
  geom_bar(aes(x = Qr_enjoyment, y = percent),
           stat = "identity",
           color = params$bar_colors,
           fill = params$bar_colors,
           width = 0.5,
           alpha = 0.5) +
  geom_text(aes(x = Qr_enjoyment, y = percent,
                label = paste0(round(percent * 100), "%")),
                color = "gray30",
                nudge_y = .03) +
  geom_vline(aes(xintercept = mean_enjoyment), color = "darkblue") +
  annotate("text", x = 4, y = 0.5, label = paste0("Mean value = ", mean_enjoyment)) +
  scale_y_continuous(labels = scales::percent) +
  labs(subtitle = question_text("Qr_enjoyment", "(R users only)", 75),
       caption = paste0(survey_name, ", n = ", diff_responses),
       x="Respondent Rating (1 = Not at all, 5 = A great deal)", y="") +
  theme(panel.background = element_rect(fill = "transparent",colour = NA),
        plot.background = element_rect(fill = "transparent",colour = NA))
plot_save("Enjoyment Using R (R Users Only).pdf")
```

## Tidyverse Learning (R Users Only)

```{r tidyverse Learning, echo = TRUE}
tidyverse_learned_dictionary <- read_delim("dictionary/tidyverse_learned_dictionary.tsv", delim = "\t", col_types = "cc")
r_tidyverse_learned_responses <- survey %>% select(Qtidyverse_learning)
r_tidyverse_learned_parsed <- r_tidyverse_learned_responses %>% 
   left_join(tidyverse_learned_dictionary, c("Qtidyverse_learning" = "Input"))
r_tidyverse_learned_exceptions <- r_tidyverse_learned_responses %>% 
  anti_join(tidyverse_learned_dictionary, c("Qtidyverse_learning" = "Input"))
r_tidyverse_learned_results <- tally_question(r_tidyverse_learned_parsed, Output, rm.na = TRUE, sort = TRUE)
r_tidyverse_learned_responses <- first(r_tidyverse_learned_results$nn)

learned_with_tidyverse <- r_tidyverse_learned_results %>% 
 mutate(Output = factor(Output, levels = Output),
         position = cumsum(percent) - percent / 2,
         label = ifelse(percent >= 2, paste0(Output, "\n", round(percent), "%"), ""))

lollipop_chart(df                 = learned_with_tidyverse,
          column_name        = Output,
          subtitle_string        = question_text("Qtidyverse_learning", "(R users only)"),
          caption_string         = paste0(survey_name, ", n = ",r_tidyverse_learned_responses),
          fill_color             = params$bar_colors)
plot_save("Tidyverse Learning (R Users Only).pdf", height = 2)
```

## Tidyverse Use (R Users Only)

```{r tidyverse, echo = TRUE}
tidyverse_use_dictionary <- read_delim("dictionary/tidyverse_use_dictionary.tsv", delim = "\t", col_types = "cc")
r_tidyverse_use_responses <- survey %>% select(Qtidyverse_today)
r_tidyverse_use_parsed <- r_tidyverse_use_responses %>% 
   left_join(tidyverse_use_dictionary, c("Qtidyverse_today" = "Input"))
r_tidyverse_use_exceptions <- r_tidyverse_use_responses %>% 
  anti_join(tidyverse_use_dictionary, c("Qtidyverse_today" = "Input"))
r_tidyverse_use_results <- tally_question(r_tidyverse_use_parsed, Output, rm.na = TRUE, sort = TRUE)
r_tidyverse_use_responses <- first(r_tidyverse_use_results$nn)

using_tidyverse <- r_tidyverse_use_results %>% 
 mutate(Output = factor(Output, levels = Output),
         position = cumsum(percent) - percent / 2,
         label = ifelse(percent >= 2, paste0(Output, "\n", round(percent), "%"), ""))

lollipop_chart(df                 = using_tidyverse,
          column_name             = Output,
          subtitle_string         = question_text("Qtidyverse_today", "(R users only)"),
          caption_string          = paste0(survey_name, ", n = ",r_tidyverse_use_responses),
          fill_color              = params$bar_colors)
plot_save("Tidyverse Use Frequency Today (R Users Only).pdf", 3)
```

## Shiny Use (R Users Only)

```{r shiny, echo = TRUE}
shiny_use_dictionary <- read_delim("dictionary/shiny_use_dictionary.tsv", delim = "\t", col_types = "cc")
shiny_use_responses <- survey %>% select(Qshiny)
shiny_use_parsed <- shiny_use_responses %>% 
   left_join(shiny_use_dictionary, c("Qshiny" = "Input"))
shiny_use_exceptions <- shiny_use_responses %>% 
  anti_join(shiny_use_dictionary, c("Qshiny" = "Input"))
shiny_use_results <- tally_question(shiny_use_parsed, Output, rm.na = TRUE, sort = TRUE)
shiny_use_responses <- first(shiny_use_results$nn)

using_shiny <- shiny_use_results %>% 
 mutate(Output = factor(Output, levels = Output),
         position = cumsum(percent) - percent / 2,
         label = ifelse(percent >= 2, paste0(Output, "\n", round(percent), "%"), ""))

lollipop_chart(df                 = using_shiny,
          column_name             = Output,
          subtitle_string         = question_text("Qshiny", "(R users only)"),
          caption_string          = paste0(survey_name, ", n = ",shiny_use_responses),
          fill_color              = params$bar_colors)
plot_save("Shiny Use Frequency Today (R Users Only).pdf")
```


## Version Control Use (R Users Only)

This question wasn't asked in 2019.

```{r version control, echo = TRUE, eval = FALSE}
version_control_use_dictionary <- read_delim("dictionary/version_control_dictionary.tsv", delim = "\t", col_types = "cc")
version_control_use_responses <- survey %>% select(Qversion_control)
version_control_use_parsed <- version_control_use_responses %>% 
   left_join(version_control_use_dictionary, c("Qversion_control" = "Input"))
version_control_use_exceptions <- version_control_use_responses %>% 
  anti_join(version_control_use_dictionary, c("Qversion_control" = "Input"))
version_control_use_results <- tally_question(version_control_use_parsed, Output, rm.na = TRUE, sort = TRUE)
version_control_use_responses <- first(version_control_use_results$nn)

using_version_control <- version_control_use_results %>% 
 mutate(Output = factor(Output, levels = Output),
         position = cumsum(percent) - percent / 2,
         label = ifelse(percent >= 2, paste0(Output, "\n", round(percent), "%"), ""))

lollipop_chart(df                 = using_version_control,
          column_name             = Output,
          subtitle_string         = question_text("Qversion_control", "(R users only)"),
          caption_string          = paste0(survey_name, ", n = ",version_control_use_responses),
          fill_color              = params$bar_colors)
plot_save("Version Control Use Frequency Today (R Users Only).pdf")
```

## Unit Tests (R Users Only)

This question wasn't asked in 2019.

```{r Unit Tests, echo = TRUE, eval = FALSE}

unit_tests_use_dictionary <- read_delim("dictionary/unit_test_use_dictionary.tsv", delim = "\t", col_types = "cc")
unit_tests_use_responses <- survey %>% select(Qunit_tests)
unit_tests_use_parsed <- unit_tests_use_responses %>% 
   left_join(unit_tests_use_dictionary, c("Qunit_tests" = "Input"))
unit_tests_use_exceptions <- unit_tests_use_responses %>% 
  anti_join(unit_tests_use_dictionary, c("Qunit_tests" = "Input"))
unit_tests_use_results <- tally_question(unit_tests_use_parsed, Output, rm.na = TRUE, sort = TRUE)
unit_tests_use_responses <- first(unit_tests_use_results$nn)

using_unit_tests <- unit_tests_use_results %>% 
 mutate(Output = factor(Output, levels = Output),
         position = cumsum(percent) - percent / 2,
         label = ifelse(percent >= 2, paste0(Output, "\n", round(percent), "%"), ""))

lollipop_chart(df                 = using_unit_tests,
          column_name             = Output,
          subtitle_string         = question_text("Qunit_tests", "(R users only)"),
          caption_string          = paste0(survey_name, ", n = ",unit_tests_use_responses),
          fill_color              = params$bar_colors)
plot_save("Unit Tests Use Frequency Today (R Users Only).pdf")
```

## Packages We Cannot Live Without (R Users Only)

This question wasn't asked in 2019.

```{r Packages We Cannot Live Without, echo = TRUE, eval = FALSE}
library(tidytext)
data(stop_words)

packages_answers <- survey %>% select(Qnot_live_without) %>% filter(!is.na(Qnot_live_without))
packages_answers <- packages_answers %>% 
  mutate(packages = str_trim(tolower(Qnot_live_without)))
tidy_packages <- packages_answers %>% unnest_tokens(words, packages)
tidy_packages <- tidy_packages %>% anti_join(stop_words, by = c("words" = "word"))

# We now need to clean up some counts; for example, ggplot and ggplot2 are the same thing.
# Also, words like data and packages aren't package names

# First words we should just remove
non_capability_words <- tibble(word = c("ability", "data", "packages", "package", "live", "easier", 
                                        "function", "functional", "functions", "entire", "easy",
                                        "machine", "learning", "capability", "general",
                                        "manipulation", "visualization", "plotting", "love",
                                        "code", "guess", "question"),
                       lexicon = "adhoc")
tidy_packages <- tidy_packages <- tidy_packages %>% anti_join(non_capability_words, by = c("words" = "word"))

# Now do replacements
replacements <- c("ggplot2" = "ggplot", "rstudio" = "RStudio IDE", "^tidy$" = "tidyverse", "^pipe$" = "magrittr")
tidy_packages <- tidy_packages %>% 
  mutate(changed_words = str_replace_all(words, replacements))
package_counts <- tidy_packages %>% 
  count(changed_words, sort = TRUE) %>% 
  rename(capability = changed_words)

num_package_responses <- nrow(tidy_packages)
packages_list <- package_counts %>% 
  mutate(percent = round(n / num_package_responses * 100)) %>% 
  select(-num_package_responses)
top_15_packages <- head(packages_list, 15)
top_15_packages <- top_15_packages %>%
  mutate(capability = factor(as.character(capability), levels = rev(capability)))

lollipop_chart_counts(top_15_packages, 
          column_name = capability, 
          fill_color = params$bar_colors, 
          subtitle_string = paste0(question_text("Qnot_live_without", "(Number of mentions shown, R users only)", 55)),
          caption_string = paste0(survey_name, ", Total Mentions = ", num_package_responses))
plot_save("R Capabilities Users Cannot Live Without (R Users Only).pdf")
```

## Things Users Like Best About R (R Users Only)

```{r Like Best About R, echo = TRUE}
likebest_answers <- survey %>% select(Qlike_best) %>% filter(!is.na(Qlike_best))
likebest_answers <- likebest_answers %>% 
  mutate(likebest = str_trim(tolower(Qlike_best)))
tidy_likebest <- likebest_answers %>% unnest_tokens(words, likebest)
tidy_likebest <- tidy_likebest %>% anti_join(stop_words, by = c("words" = "word"))

# We now need to clean up some counts; for example, ggplot and ggplot2 are the same thing.
# Also, words like data and likebest aren't package names

# First words we should just remove
non_capability_words <- tibble(word = c("ability", "data", "package", "live", "easier", 
                                        "function", "functional", "functions", "entire", "easy",
                                        "machine", "learning", "capability", "general",
                                        "love", "lot", "de", "la",
                                        "code", "guess", "question", "makes", "online", "learn"),
                       lexicon = "adhoc")
tidy_likebest <- tidy_likebest <- tidy_likebest %>% anti_join(non_capability_words, by = c("words" = "word"))

# Now do replacements
replacements <- c("ggplot2" = "ggplot", "rstudio" = "RStudio", "powerful" = "power")
tidy_likebest <- tidy_likebest %>%
  mutate(changed_words = str_replace_all(words, replacements))
likebest_counts <- tidy_likebest %>% 
  count(changed_words, sort = TRUE) %>% 
  rename(capability = changed_words)

num_likebest_responses <- nrow(tidy_likebest)
likebest_list <- likebest_counts %>% 
  mutate(percent = round(n / num_likebest_responses * 100)) %>% 
  select(-num_likebest_responses)
top_15_likebest <- head(likebest_list, 15)
top_15_likebest <- top_15_likebest %>%
  mutate(capability = factor(as.character(capability), levels = rev(capability)))

lollipop_chart_counts(top_15_likebest, 
          column_name = capability, 
          fill_color = params$bar_colors, 
          subtitle_string = question_text("Qlike_best", "(Number of mentions shown, R users only)", 55),
          caption_string = paste0(survey_name, ", Total Mentions = ", num_likebest_responses))
plot_save("R Capabilities Users Like Best (R Users Only).pdf")
```

## Things Users Like least About R (R Users Only)

```{r Like Least About R, echo = TRUE}
likeleast_answers <- survey %>% select(Qlike_least) %>% filter(!is.na(Qlike_least))
likeleast_answers <- likeleast_answers %>% 
  mutate(likeleast = str_trim(tolower(Qlike_least)))
tidy_likeleast <- likeleast_answers %>% unnest_tokens(words, likeleast)
tidy_likeleast <- tidy_likeleast %>% anti_join(stop_words, by = c("words" = "word"))

# We now need to clean up some counts; for example, ggplot and ggplot2 are the same thing.

# First words we should just remove
non_capability_words <- tibble(word = c("ability", "data", "package", "live", "easier", 
                                        "function", "functional", "functions", "entire", "easy",
                                        "machine", "learning", "capability", "general",
                                        "love", "lot", "hard", "lack", "curve",
                                         "de", "la", "hate",
                                        "code", "guess", "question", "makes", "online", "learn",
                                        "it’s", "e.g", "e.g.", "understand"),
                       lexicon = "adhoc")
tidy_likeleast <- tidy_likeleast <- tidy_likeleast %>% anti_join(non_capability_words, by = c("words" = "word"))

# Now do replacements
replacements <- c("ggplot2" = "ggplot", 
                  "rstudio" = "RStudio", 
                  "powerful" = "power",
                  "error" = "errors",
                  "errorss" = "errors")
tidy_likeleast <- tidy_likeleast %>%
  mutate(changed_words = str_replace_all(words, replacements))
likeleast_counts <- tidy_likeleast %>% 
  count(changed_words, sort = TRUE) %>% 
  rename(capability = changed_words)

num_likeleast_responses <- nrow(tidy_likeleast)
likeleast_list <- likeleast_counts %>% 
  mutate(percent = round(n / num_likeleast_responses * 100)) %>% 
  select(-num_likeleast_responses)
top_15_likeleast <- head(likeleast_list, 15)
top_15_likeleast <- top_15_likeleast %>%
  mutate(capability = factor(as.character(capability), levels = rev(capability)))

lollipop_chart_counts(top_15_likeleast, 
          column_name = capability, 
          fill_color = params$bar_colors, 
          subtitle_string = question_text("Qlike_least", "(Number of mentions shown, R users only)", 40),
          caption_string = paste0(survey_name, ", Total Mentions = ", num_likeleast_responses))
plot_save("R Capabilities Users Like Least (R Users Only).pdf")
```

# Non-R Users Section

## Most Difficult Aspect of Learning (Non-R Users)

```{r Most Difficult Aspect of Learning, echo = TRUE}

most_difficult_dictionary <- read_delim("dictionary/difficult_aspect_dictionary.tsv", delim = "\t", col_types = "cc")
difficult_use_responses <- survey %>% 
  select(Qmost_difficult_aspect) %>% 
  mutate(Qmost_difficult_aspect = str_trunc(Qmost_difficult_aspect, 40))
difficult_aspects_parsed <- difficult_use_responses %>% 
   left_join(most_difficult_dictionary, c("Qmost_difficult_aspect" = "Input")) %>% 
  drop_na()
difficult_aspects_exceptions <- difficult_use_responses %>% 
  anti_join(most_difficult_dictionary, c("Qmost_difficult_aspect" = "Input"))
difficult_aspects_results <- tally_question(difficult_aspects_parsed, Output, rm.na = TRUE, sort = TRUE)
difficult_aspects_responses <- first(difficult_aspects_results$nn)

r_difficult_aspect <-difficult_aspects_results %>%
  mutate(Output = factor(as.character(Output), levels = rev(Output)))

lollipop_chart_counts(r_difficult_aspect, 
          column_name = Output, 
          fill_color = params$bar_colors, 
          subtitle_string = question_text("Qmost_difficult_aspect", "(Number of mentions shown, non-R users only)", 60),
          caption_string = paste0(survey_name, ", n = ", diff_responses))
plot_save("Most Difficult Aspect of Learning (Non-R Users).pdf")

```

## Expected Time To Success (Non-R Users)

```{r Expected Time To Success, echo = TRUE}

# We can use the same dictionary as the proficiency one
learning_times_dictionary <- read_delim("dictionary/r_proficiency_dictionary.tsv", delim = "\t", col_types = "cc")
expected_time_to_learn_responses <- survey %>% 
  select(Qr_length_to_success) %>% 
  mutate(Qr_length_to_success = str_trunc(Qr_length_to_success, 40))
expected_time_to_learn_parsed <- expected_time_to_learn_responses %>% 
   left_join(learning_times_dictionary, c("Qr_length_to_success" = "Input")) %>% 
  drop_na()
expected_time_to_learn_exceptions <- expected_time_to_learn_responses %>% 
  anti_join(learning_times_dictionary, c("Qr_length_to_success" = "Input"))
expected_time_to_learn_results <- tally_question(expected_time_to_learn_parsed, Output, rm.na = TRUE, sort = TRUE)
expected_time_to_learn_responses <- first(expected_time_to_learn_results$nn)

r_expected_time_to_learn <- expected_time_to_learn_results %>%
  mutate(learning_time = factor(as.character(Output), levels = rev(Output)),
         position = cumsum(percent) - percent / 2,
         label = ifelse(percent >= 10, paste0(learning_time, "\n", round(percent), "%"), ""))

lollipop_chart(r_expected_time_to_learn, 
          column_name = learning_time,
          fill_color = params$bar_colors, 
          subtitle_string = question_text("Qr_length_to_success", "(Non-R users)", 60),
          caption_string = paste0(survey_name, ", n = ", diff_responses))
plot_save("Expected Time To Success (Non-R Users).pdf")
```

## R Difficulty (Non-R Users)

```{r Difficulty Learning for non-R users, echo = TRUE}

r_difficulty <- tally_question(survey, Qr_difficulty, rm.na = TRUE, sort = FALSE)
diff_responses <- first(r_difficulty$nn)
mean_difficulty = round(mean(survey$Qr_difficulty, na.rm = TRUE), 1)

r_difficulty <- r_difficulty %>%
  mutate(percent = percent / 100)      # the plot below uses a percent y axis

ggplot(r_difficulty) +
  geom_bar(aes(x = Qr_difficulty, y = percent),
           stat = "identity",
           color = params$bar_colors,
           fill = params$bar_colors,
           width = 0.5,
           alpha = 0.5) +
  geom_text(aes(x = Qr_difficulty, y = percent,
                label = paste0(round(percent * 100), "%")),
                color = "gray30",
                nudge_y = .03) +
  geom_vline(aes(xintercept = mean_difficulty), color = "darkblue") +
  annotate("text", x = 4, y = 0.4, label = paste0("Mean value = ", mean_difficulty)) +
  scale_y_continuous(labels = scales::percent) +
  labs(title = "Expected Difficulty in Learning R (Non-R Users)", 
       subtitle = question_text("Qr_difficulty", 72),
       caption = paste0(survey_name, ", n = ", diff_responses),
       x="Respondent Rating (1 = Easiest, 5 = Most Difficult)", y="")
  plot_save("Expected Difficulty in Learning R (Non-R Users).pdf")
```

## How Do You Plan To Learn R  (Non-R Users)

```{r How Do You Plan To Learn R, echo = TRUE}
# We shorten down the given answers while categorizing open-text answers given for "Other"
# Just as we did for the gender and industry questions, we use small dictionary to do this
# However, because commas may appear in the open text respones, we'll use a tsv file instead of a csv one.

r_plan_dictionary <- read_delim("dictionary/learning_plan_dictionary.tsv", delim="\t")
r_plan <- survey %>% select(Qhow_to_learn_r) %>% left_join(r_plan_dictionary, c("Qhow_to_learn_r" = "Input"))
r_learning_plan <- tally_question(r_plan, Output, rm.na = TRUE, sort = TRUE)
r_plan_responses <- first(r_learning_plan$nn)

r_learning_plan <-r_learning_plan %>% 
 mutate(Output = factor(Output, levels = Output),
         position = cumsum(percent) - percent / 2,
         label = ifelse(percent >= 2, paste0(Output, "\n", round(percent), "%"), ""))

lollipop_chart(df                 = r_learning_plan,
          column_name        = Output,
          subtitle_string        = question_text("Qhow_to_learn_r", "(Non-R users)"),
          caption_string         = paste0(survey_name, ", n = ", r_plan_responses),
          fill_color                 = params$bar_colors)


```
## Tidyverse Use versus R Year  (R Users Only)

```{r Tidyverse Use versus R Year, echo = TRUE}

td_use_by_year <- survey %>% 
  filter(Qr_year >= 1900) %>% 
  group_by(Qr_year) %>% 
  summarize(usetd = sum(Qtidyverse_today %in% c("Usually")),
            usetd_count = sum(!is.na(Qtidyverse_today)),
            percent = round(usetd / usetd_count * 100, 1)) %>% 
  filter(usetd_count >= 10)

ggplot(td_use_by_year, aes(x = Qr_year, y = percent)) +
         geom_point() + 
         geom_smooth(method = "lm") +
         ylim(0,100) +
         labs(x = "Year Learned R",
                y = "Percent Who Usually Use Tidyverse")
```

## Age When Respondents Learned R (All Respondents)

```{r Age when respondents learned R, echo = TRUE}

r_ages <- survey %>% select(Qr_year, Qyear_born) %>% filter(Qr_year >= 1990 & Qyear_born >= 1900) %>% mutate(age_learned_r = Qr_year - Qyear_born)
mean_age_learned_r <- mean(r_ages$age_learned_r, na.rm = TRUE)
median_age_learned_r <- round(median(r_ages$age_learned_r, na.rm = TRUE))
r_year_responses <- sum(!is.na(r_ages$age_learned_r))
r_year_tally <- tally_question(r_ages, age_learned_r)

ggplot(r_ages) +
  geom_histogram(aes(x = age_learned_r), binwidth = 1,  fill = params$bar_colors, color="white") +
  geom_vline(aes(xintercept = mean_age_learned_r), color = "lightblue") +
  annotate("text", x = mean_age_learned_r + 8, y = 150, label = paste0("Mean age = ", round(mean_age_learned_r, 0))) +
  scale_x_continuous(breaks = seq(15,80,5), limits = c(15, 80)) +
  labs(title = "Ages When Respondents Started Learning R (All Respondents)", x="Age", y="Count") +
  theme(panel.background = element_rect(fill = "transparent",colour = NA),
        plot.background = element_rect(fill = "transparent",colour = NA))
plot_save("Ages When Respondents Learned R.pdf", height = 3)
```
