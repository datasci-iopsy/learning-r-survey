---
title: "Learning R Survey Results"
author: "Carl Howe, RStudio"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: ["default", "css/rstudio.css", "css/fonts.css"]
    lib_dir: libs
    nature:
      slideNumberFormat: ""
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: "16:9"
      beforeInit: "https://platform.twitter.com/widgets.js"
    seal: false 
    includes:
      in_header: header.html
params:
  bar_colors: "#4c83b6"
  language: English
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.retina = 3,
                      fig.asp = 0.618, fig.width = 12, fig.path = "figures/")
library(choroplethr)
library(choroplethrMaps)
data(country.map)
library(tidyverse)
library(RColorBrewer)
library(gendercodeR)
library(ggrepel)
library(extrafont)
library(ggalt)    # devtools::install_github("hrbrmstr/ggalt")
library(ggthemes) # theme_map 

# for plots
survey_name <- "2018 RStudio Learning R Survey"

# ggplot2::theme_set(theme_minimal())
# update those fontdefaults
update_font_defaults <- function(font_choice = "Lato", font_size = 5) {
    ggplot2::update_geom_defaults("text", list(family = font_choice, size = font_size))
    ggplot2::update_geom_defaults("label", list(family = font_choice, size = font_size))
    
}
theme_conf <- function(font_choice = "Lato"){ 
  
  update_font_defaults()
  
  ggplot2::theme_minimal(base_family = font_choice,
                         base_size = 18)
  
}

# set custom ggplot2 theme for plots
ggplot2::theme_set(theme_conf())

# get the data
survey <- read_tsv(here::here("slides/data", paste0("survey_", params$language,".tsv")))
survey_questions <- read_csv(here::here("slides/data/survey_questions.csv"))
# Saving some metadata for later
respondents <- nrow(survey)
```

layout: true
  
<div class="my-footer"><span>rstd.io/survey</span></div>

<!-- this adds the link footer to all slides, depends on my-footer class in css-->

---
name: title
background-image: url(img/title-blue.png)
background-size: cover
class: inverse

# Learning R 

<br>
<br>

<img src="img/RStudio-Logo-White.png" alt="rstudio-logo" width = '30%' />

<br>
<br>

### Our Community Survey

.large[Carl Howe | rstudio::conf | `r Sys.Date()`]

<!-- this ends up being the title slide since seal = FALSE-->


---
exclude: true

- All data updated as of 2019-01-03 using script in slides/R/process-survey-multilang.R

- The survey data is exported from that script to slides/data/survey-<language>.tsv

- The survey questions are exported from that script to slides/data/survey_questions.csv

- Both files are then imported in this slide deck

- You'll need the Lato Google fonts installed to embed it within the ggplot2 figures (https://fonts.google.com/specimen/Lato)

- You'll need the following R packages installed

```{r eval = FALSE}
install.packages(choroplethr)
install.packages(choroplethrMaps)
install.packages(tidyverse)
install.packages(RColorBrewer)
install.packages(gendercodeR)
install.packages(ggrepel)
install.packages(extrafont)
devtools::install_github("hrbrmstr/ggalt")   
install.packages(ggthemes) # theme_map 
```


???

put your presenter notes here

---
class: inverse, middle

# Methodology

--

.pull-left[
- Survey conducted between December 6 and December 31, 2018

- Data and processing scripts can be found the repo at the end of this talk

- Data and scripts are open source
]

--

.pull-right[
- Survey was fielded in both English and Spanish versions

- Respondents solicited from
    + community.rstudio.com
    + Twitter followers of RStudio employees
    + reddit.com/datascience
    
- Survey results are not representative of any broader population
]

```{r helpers, include=FALSE}
### Let's define helper functions before we get going:
###

# This tallies up the results for a question
# rm.na = TRUE to calculate percentages based on non-NA results; set to FALSE to include NAs
# set sort = TRUE sorts the result by count; set to FALSE to return in whatever order they occur

tally_question <- function(df, question_name, rm.na = TRUE, sort = TRUE) {
  quoted_question <- enquo(question_name)
  filtered_df <- df
  if (rm.na) {
    filtered_df <- filtered_df %>% filter(!is.na(!!quoted_question))
  }
  results_df <- filtered_df %>% 
    count(!!quoted_question, sort = sort, name = "n") %>% 
    add_tally(name = "nn") %>% 
    mutate(percent = round(n / nn * 100))
  return(results_df)
}


# Split and aggregate: derives multiple answers to a single question by separating on commas and returning
# the results as an embedded list in the dataframe.
split_and_aggregate <- function(df, question_name) {
  quoted_question <- enquo(question_name)
  responses_df <- df %>% summarize(responses = sum(!is.na(!!quoted_question)))
  splits <- df %>% mutate(items = purrr::map(!!quoted_question, str_split, ", ")) %>% unnest()
  
  aggregated_items <- splits %>% unnest() %>% group_by(items) %>% count(sort=TRUE)
  aggregated_items <- aggregated_items %>% mutate(num_responses = responses_df$responses)
  return(aggregated_items)
}

# Top N choices: function to distill many possible results to a question to the top N
# responses, with the rest aggregated into an "Other" answer.
top_n_choices <- function(df, column_name, total_responses, num = 10) {
  
  quoted_column_name <- enquo(column_name)
  summarized_responses <- df %>% 
    mutate(percent = round(n / total_responses * 100)) %>% 
    arrange(desc(percent))

  # Now take these responses and only show the top N, aggregating the rest into an Other category

  literals <- head(summarized_responses, num) %>% 
    ungroup()
  other <- tail(summarized_responses, -num) %>% 
    ungroup() %>% 
    summarize(!!quoted_column_name := "Other", 
              n = sum(n),
              percent = round(n / first(total_responses) * 100))
  top_n <- rbind(literals, other) %>% drop_na()
  return(top_n)
}

question_text <- function(question_name_string, wrap_length = 55)
{
   question_text <- survey_questions %>% filter(Question_name == question_name_string) %>% select(Question_text)
   if (str_length(question_text$Question_text) >= wrap_length) {
     return_text <- question_text$Question_text %>% str_wrap(width = wrap_length - 5)
   } else {
     return_text <- question_text$Question_text
   }
   return(paste0('"', return_text, '"'))
}

## Plot a pie chart from a single response question. The call form is a little baroque, so here's an example
## to illustrate the mapping of values to arguments.
##     pie_chart(df = ethnicities, 
##               column_name                 = Qethnicity_coded, 
##               text_position_expression    = 100 - position  ## the name of the position column in the df
##               title_string                = "Ethnicities",
##               subtitle_string             =  question_text("Qethnicity", 50)
##               fill_legend_title           = "Respondent Ethnicity"
##               colors                      = "Set1"         From the RColorBrewer palettes

pie_chart <- function(df, 
                      column_name,                # non-standard evalation column name
                      text_position_expression,   # either a column name or an expression
                      title_string = "",
                      subtitle_string = "",
                      caption_string = survey_name,
                      fill_legend_title = "",
                      colors = "Set1") {
  quoted_column_name <- enquo(column_name)
  quoted_position <- enquo(text_position_expression)
  p <- ggplot(df) +
    geom_col(aes(x = 1, y = percent, fill = !!quoted_column_name), 
             width = 1, size = 1, color = "gray90", alpha = 0.4) +
    geom_text(aes(x = 1.22, y = !!quoted_position, label = label),
                    size = 3,
                    hjust = 0.4,
                    color = "black"
     ) +
    labs(x = NULL, y = NULL, 
         title = title_string,
         subtitle = subtitle_string,
         caption = caption_string,
         fill = fill_legend_title) +
    guides(fill = guide_legend()) +
    scale_fill_brewer(palette = colors) +
    #   scale_fill_viridis_d("Ethnicities", option = "A", direction = -1, alpha = 0.4) +
    #theme_classic() +
    coord_polar("y") +
    #    coord_flip() +
    theme(legend.key.width = unit(1, "cm"),
          axis.line = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          panel.grid  = element_blank()) #<< needed to add this 
  print(p)
  #return(p)
}

## Plot a simple horizontal bar chart. The call form is a little baroque, so here's an example
## to illustrate the mapping of values to arguments.
##     bar_chart(df = ethnicities, 
##               column_name            = Qethnicity_coded, 
##               original_column_string = "Qethnicity",
##               text_position          = position        ## the name of the position column in the df
##               title_string           = "Ethnicities", 
##               fill_legend_title      = "Respondent Ethnicity"
##               colors                 = "Set1"         From the RColorBrewer palettes

bar_chart <- function(df,
                     column_name, 
                     fill_color,
                     title_string,
                     subtitle_string = "",
                     caption_string = survey_name) {
  
  quoted_column <- enquo(column_name)
  nudge_amount <- max(df$percent, rm.na = TRUE) * 0.05
  p <- ggplot(df) +
    geom_col(aes(x = !!quoted_column, y = percent),
             fill =  fill_color) +
    geom_text(aes(x = !!quoted_column, y = percent , 
                  label = paste0(percent, "%")), 
              color="gray30", size=3, nudge_y = nudge_amount) +
    labs(title = title_string, 
         subtitle = subtitle_string,
         caption = caption_string,
         x="", y="") +
    coord_flip() +
    theme(axis.line = element_blank(),
          axis.text.x = element_blank(),
          axis.ticks = element_blank())
  print(p)
  #return(p)
}

# Chop and prop: 
# input: a df, a column in that df, and (optional) number of "items" (unique responses to keep, top 15 is default)
# output: a df with the original quoted question name/items, the items as processed by fct_lump, and the n and prop_responses for plotting (need the proportions to take advantage of scales::percent when plotting)
chop_and_prop <- function(df, question_name, num_items = 15) {
  quoted_question <- enquo(question_name)
  responses <- df %>% summarize(responses = sum(!is.na(!!quoted_question))) %>% pull()
  chops <- df %>% 
    mutate(items = str_remove(!!quoted_question, "i.e., ")) %>% 
    tidyr::separate_rows(items, sep = ", ") %>% 
    mutate(items = forcats::fct_lump(as.factor(items), n = num_items))
  prop_items <- chops %>% 
    count(items) %>% 
    tidyr::drop_na(items) %>% 
    mutate(prop_responses = n / responses,
           total_responses = responses)
  return(prop_items)
}

## Plot a simple lollipop plot. Intended to be used after chop_and_prop
##     lollipop_chart(df = ethnicities, 
##               column_name            = Qethnicity_coded, 
##               original_column_string = "Qethnicity",
##               text_position          = position        ## the name of the position column in the df
##               title_string           = "Ethnicities", 
##               fill_legend_title      = "Respondent Ethnicity"
##               colors                 = "Set1"         From the RColorBrewer palettes

lollipop_chart <- function(df,
                     column_name, 
                     fill_color,
                     title_string = NULL,
                     subtitle_string = "",
                     caption_string = survey_name,
                     pct_accuracy = .1) {
  
  quoted_column <- enquo(column_name)
  nudge_amount <- max(df$prop_responses, na.rm = TRUE) * 0.05
  p <- ggplot(df, aes(x = fct_relevel(fct_reorder(!!quoted_column, prop_responses), "Other"), 
                      y = prop_responses)) +
    geom_point(color = fill_color, size = 3) +
    geom_segment(aes(xend = fct_rev(!!quoted_column), yend = 0), 
                 color = fill_color,
                 size = 1.5,
                 alpha = .7) +
    geom_text(aes(label = scales::percent(prop_responses, accuracy = pct_accuracy)), 
              hjust = -.25, 
              color="black") +
    labs(title = title_string, 
         subtitle = subtitle_string,
         caption = caption_string,
         x="", y="") +
    coord_flip() +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, .95)) 
  print(p)
  #return(p)
}
```

---
class: middle

.left-column[
## Responses over time
]

.right-column[

```{r responses over time}
survey <- survey %>% mutate(number_responses = cumsum(!is.na(Qtime)))
ggplot(survey) + 
  geom_line(aes(x=Qtime, y=number_responses)) + 
  ggtitle(sprintf("%s Survey Responses Over Time (N = %d)", params$language, respondents)) + 
  labs(y = "Count", x = "Response Date")
```
]

---
class: inverse, middle

# Our Community Diversity

---
class: middle

.left-column[
## Age Diversity
]

.right-column[

```{r Respondent Ages}
ggplot(survey) +
  geom_histogram(aes(2018 - Qyear_born), binwidth = 5, fill = params$bar_colors,
                 color=params$bar_colors, alpha = .7) +
  #scale_x_continuous(breaks = seq(15,80,5)) +
  labs(x="Age", y="Count")
```

]

---
class: middle

.left-column[

## Gender Diversity
]

.right-column[

```{r Respondent Gender}
genders <- survey %>% 
  group_by(Qgender_coded) %>% 
  count(sort = TRUE) %>% 
  mutate(unit = 1) %>% 
  drop_na()

gender_responses <- sum(genders$n, na.rm = TRUE)
genders <- genders %>% 
  group_by(unit) %>% 
  mutate(percent = round(n / gender_responses * 100),
         position = cumsum(percent) - percent / 2,
         label = ifelse(percent >= 10, paste0(percent, "%"), "")) %>% 
  arrange(desc(percent)) %>% 
  mutate(Qgender_coded = factor(as.character(Qgender_coded), 
                                levels = c("female", "male", "sex and gender diverse", "unclear")))

pie_chart(df                 = genders,
          column_name        = Qgender_coded,
          subtitle_string    = question_text("Qgender"),
          text_position          = position,
          title_string           = "Respondent Gender",
          fill_legend_title      = "Gender",
          colors                 = "Set1")
```

]

---
class: middle
name: alison-gender-props

.left-column[

## Gender Diversity
]

.right-column[

```{r Respondent Gender2}
genders <- chop_and_prop(survey, Qgender_coded, num_items = 4)

lollipop_chart(genders, 
          column_name = items, 
          fill_color = params$bar_colors, 
          subtitle_string = question_text("Qgender"),
          caption_string = paste0(survey_name, ", n = ", genders$total_responses))
```

]


---
class: middle
name: alison-gender-age

.left-column[

### Minority Gender Representation
]

.right-column[

```{r Respondent Gender Age}
minority_genders <- survey %>% 
  mutate(Qgender_coded = forcats::fct_lump(as.factor(Qgender_coded), 
                                           n = 2, 
                                           other_level = "sex & gender diverse")) %>% 
  drop_na(Qgender_coded) %>% 
  filter(!Qyear_born == 2018)
ggplot(minority_genders, aes(2018 - Qyear_born, fill = Qgender_coded)) +
  geom_histogram(data = filter(minority_genders, Qgender_coded == 'male'),
                 binwidth = 2, colour = "white", alpha = .8) +
  geom_histogram(data = filter(minority_genders, Qgender_coded == 'female'),
                 binwidth = 2, colour = "white", alpha = .8) +
  geom_histogram(data = filter(minority_genders, Qgender_coded == 'sex & gender diverse'),
                 binwidth = 2, colour = "white", alpha = .8) +
  #scale_x_continuous(breaks = seq(15,80,5)) +
  labs(x="Age", y="Count", fill = "") +
  scale_fill_viridis_d() +
  theme(legend.position="bottom")
```

]



---
class: middle
name: alison-facet-background

.left-column[

### Minority Gender Representation
]

.right-column[

```{r Respondent Gender Age Facet}
minority_genders <- survey %>% 
  mutate(Qgender_coded = forcats::fct_lump(as.factor(Qgender_coded), n = 1, other_level = "non-male")) %>% 
  drop_na(Qgender_coded) %>% 
  filter(!Qyear_born == 2018) 
ggplot(minority_genders, aes(2018 - Qyear_born)) +
  geom_histogram(data = select(minority_genders, -Qgender_coded),
                 binwidth = 2, alpha = .3) +
  geom_histogram(aes(fill = Qgender_coded), binwidth = 2, colour = "white", alpha = .8) +
  labs(x="Age", y="Count", fill = "") +
  scale_fill_viridis_d(begin = .2, end = 1) +
  facet_wrap(~ Qgender_coded) +
  guides(fill = FALSE)  # to remove the legend
```

]

???

The grey histograms are the background data


---
class: middle

.left-column[
## Respondent Countries
]

.right-column[

```{r Respondent Countries}
countries <- survey %>% count(Qcountry, sort=TRUE) %>% drop_na()
names(countries) <- c("region", "value")
countries <- countries %>% mutate(region = tolower(region))
unknown_countries <- c("singapore", "korea", "south", "serbia and montenegro", "hong kong", "andorra", "bahrain", "christmas island", "macau", "mauritius", "puerto rico", "tanzania")
choro_countries <- countries %>% filter(!(region %in% unknown_countries))
choro_countries <- choro_countries %>% mutate(region = str_replace_all(region, "korea, south", "south korea"))

# country_choropleth(choro_countries, title = "", legend = "", num_colors = 8,
#  zoom = NULL)

plot_countries <- country.map %>% left_join(choro_countries, by = "region")
ggplot(data = plot_countries, aes(long, lat, group=group)) + 
  geom_polygon(aes(fill = value), color = "gray", size=0.1) +
  scale_fill_gradient(trans = "log10", low = "dark blue", high = "yellow") +
  coord_fixed(1.3) +
  scale_x_continuous(breaks = seq(-150, 150, 60)) +
  scale_y_continuous(breaks = seq(-60, 90, 30), limits = c(-60, 90)) +
  labs(title = "Geographical Distribution of Survey Respondents", 
       subtitle = question_text("Qcountry"),
       caption = survey_name,
       x = "", y = "", fill = "Responses")
```

]
---
class: middle
name: alison-map

.left-column[
## Geographic Diversity
]

.right-column[

```{r}
world <- map_data("world")
world <- world[world$region != "Antarctica",] # intercourse antarctica
 
countries <- survey %>% 
  count(Qcountry, sort=TRUE) %>% 
  drop_na() %>% 
  mutate(Qcountry = case_when(
    Qcountry == "United States of America" ~ "USA",
    Qcountry == "United Kingdom" ~ "UK",
    Qcountry == "Korea, South" ~ "South Korea",
    TRUE ~ Qcountry
  )) %>% 
  filter(Qcountry %in% world$region) %>% 
  left_join(world, by = c("Qcountry" = "region"))
 
gg <- ggplot()
gg <- gg + geom_map(data=world, map=world,
                    aes(x=long, y=lat, map_id=region),
                    color="white", fill="#7f7f7f", size=0.05, alpha=1/4)
gg <- gg + geom_map(data=countries, map=world,
                    aes(x=long, y=lat, map_id=Qcountry, fill = n),
                    size=0.05, alpha=3/4)
gg <- gg + coord_proj("+proj=wintri")
gg <- gg + theme_map(base_size = 18, base_family = "Lato")
gg <- gg + theme(strip.background=element_blank())
gg <- gg + scale_fill_viridis_c(trans = "log10", alpha = .9, end = .9) 
gg <- gg + labs(subtitle = question_text("Qcountry"),
       caption = survey_name,
       x = "", y = "", fill = "Responses") 
gg <- gg + theme(plot.subtitle = element_text(hjust = 1)) 
gg
```

]



???

Using help from Bob Rudis (https://rud.is/b/2015/12/28/world-map-panel-plots-with-ggplot2-2-0-ggalt/)

---

# Industry

```{r Respondent industry}
industry <- survey %>% count(Qindustry, sort = TRUE)
industry_responses <- sum(!is.na(survey$Qindustry))
industry <- industry %>% mutate(percent = round(n / industry_responses * 100, 0))

top_10_industries <- top_n_choices(industry, Qindustry, industry_responses, 10)

# ggplot(industry, aes(area = percent, fill = as.numeric(percent), label = sprintf("%s\n%d%%", Qindustry, percent))) +
#  geom_treemap() +
#  geom_treemap_text(color = "white", 
#                    place = "center",
#                    reflow = TRUE) +
#  scale_fill_continuous(type = "gradient") +
#  labs(title = "Respondent Industry")

top_10_industries <- top_10_industries %>% 
  mutate(short_industry = str_replace(Qindustry, " \\(Federal, State, or Local\\)", ""),
         short_industry = str_replace(short_industry, "Services", "Svcs."),
         short_industry = str_replace(short_industry, "Information Technologies", "Info. Tech."),
         short_industry = str_replace(short_industry, "Professional and ", "Prof./"),
         short_industry = str_replace(short_industry, " and Activities", ""),
         short_industry = str_replace(short_industry, " and Medicine", ""),
         short_industry = str_replace(short_industry, " Resources and ", " Resources/"),
         short_industry = str_replace(short_industry, " and ", " & "))
         
top_10_industries <- top_10_industries %>% 
  mutate(Qindustry = factor(Qindustry, levels = Qindustry),
         position = cumsum(percent) - percent / 2,
         label = ifelse(percent >= 5, paste0(short_industry, "\n", round(percent), "%"), ""))

pie_chart(df                     = top_10_industries,
          column_name            = Qindustry,
          text_position          = 100 - position,
          title_string           = "Respondent Industry",
          subtitle_string        = question_text("Qindustry"),
          fill_legend_title      = "",
          caption_string         = paste0("RStudio Learning R Survey, n = ",industry_responses),
          colors                 = "Set3")
```

---
# Ethnicity

```{r Ethnicity}
# Multiple categories selected will be separated by commas, so we'll count those as multiple ethnicities
# This will probably miscategorize some open ends, but a quick analysis showed we have very few open ends
# with embedded commas.

ethnicities <-survey %>% group_by(Qethnicity_coded) %>% count(sort = TRUE)
num_ethnicity_responses <- sum(!is.na(survey$Qethnicity_coded))
ethnicities <- ethnicities %>% 
  mutate(percent = round(n / num_ethnicity_responses * 100, 0)) %>%
  ungroup() %>% 
  drop_na() %>% 
  arrange(desc(percent))

ethnicities <- ethnicities %>% 
 mutate(unit = 1,
        Qethnicity_coded = factor(as.character(Qethnicity_coded), levels = Qethnicity_coded),
        position = cumsum(percent) - percent / 2,
        x_position = cumsum(unit) %% 3 * 0.06 + (1 - 0.06),
        label = ifelse(percent >= 2, paste0(Qethnicity_coded, "\n", round(percent), "%"), ""))

## Another customized pie chart here to use repelled labels to show small minority groups

ggplot(ethnicities) +
    geom_col(aes(x = 1, y = percent, fill = Qethnicity_coded), 
             width = 0.2, size = 1, color = "gray90", alpha = 0.4) +
    geom_text(aes(x = x_position, y = 100 - position, label = label),
              size = 3,
              hjust = 0.4,
              color = "black",
#              direction = "y",
#              force = 0.8
    ) +
    labs(x = NULL, y = NULL, 
         title = "Respondent Ethnicities",
         subtitle = question_text("Qethnicity"),
         caption = paste0(survey_name, ", n = ", num_ethnicity_responses),
         fill = "Selected Ethnicity") +
    guides(fill = guide_legend()) +
    scale_x_continuous(limits = c(0.75, 1.25)) +
    scale_fill_brewer(palette = "Set1") +
#   scale_fill_viridis_d("Ethnicities", option = "A", direction = -1, alpha = 0.4) +
    theme(legend.key.width=unit(1, "cm")) +
    #theme_classic() +
#   coord_polar("y") +
    coord_flip() +
    theme(axis.line = element_blank(),
         axis.text = element_blank(),
         axis.ticks = element_blank())

```

---
exclude: true

# Education Level

showing you how to exclude a whole slide, also the tally function not working here so eval is FALSE

```{r Education level, eval = FALSE}

r_education_dictionary <- read_delim(here::here("data/education-dictionary.tsv"), delim = "\t")
r_education <- survey %>% select(Qdegree) %>% 
  drop_na() %>% 
  left_join(r_education_dictionary, c("Qdegree" = "Input"))
r_education_exceptions <- survey %>% select(Qdegree) %>% 
  drop_na() %>% 
  anti_join(r_education_dictionary, c("Qdegree" = "Input"))
r_education_results <- tally_question(r_education, Output, na.rm = TRUE, sort = TRUE)
# answer_table <- r_paths %>% select(Qr_learning_path, n)
# write_delim(answer_table, "data/r-path-dictionary.tsv", delim="\t")
r_education_responses <- first(r_education_results$nn)

r_education_results <- r_education_results %>% 
 mutate(Output = factor(Output, levels = rev(Output)),
         position = cumsum(percent) - percent / 2,
         label = ifelse(percent >= 2, paste0(Output, "\n", round(percent), "%"), ""))

bar_chart(df                     = r_education_results,
          column_name            = Output,
          fill_color             = params$bar_colors,
          title_string           = "Respondent Education Levels",
          subtitle_string        = question_text("Qdegree"),
          caption_string         = paste0(survey_name, ", n = ", r_education_responses)
)
```

---
exclude: true

# Job Title

```{r Job title, eval = FALSE}
job_title_dictionary <- read_delim(here::here("data/work-title-dictionary.tsv"), delim = "\t")
job_titles <- survey %>% select(Qwork_title) %>% 
  drop_na() %>% 
  left_join(job_title_dictionary, c("Qwork_title" = "Input"))
job_title_exceptions <- survey %>% select(Qwork_title) %>% 
  drop_na() %>% 
  anti_join(job_title_dictionary, c("Qwork_title" = "Input"))

job_title_totals <- job_titles %>% count(Output, sort = TRUE)
job_title_responses <- sum(!is.na(survey$Qwork_title))
job_titles <- job_title_totals %>% mutate(percent = round(n / job_title_responses * 100, 0))

top_10_titles <- top_n_choices(job_titles, Output, job_title_responses, 10)

top_10_titles <- top_10_titles %>% 
  mutate(JobTitle = factor(Output, levels = rev(Output)),
         position = cumsum(percent) - percent / 2,
         label = ifelse(percent >= 5, paste0(JobTitle, "\n", round(percent), "%"), ""))

bar_chart (df = top_10_titles,
          column_name = JobTitle,
          fill_color = params$bar_colors,
          title_string           = "Respondent Job Title",
          subtitle_string        = question_text("Qwork_title"),
          caption_string         = paste0("RStudio Learning R Survey, n = ",job_title_responses))
```

---
# Languages Used Prior To R



```{r Languages Used Prior To Learning R}

languages <- survey %>% select(Qlanguages)
num_language_responses <- sum(!is.na(languages$Qlanguages))
languages_used <- split_and_aggregate(languages, Qlanguages)
languages_used <- languages_used %>% 
  select(-num_responses) %>% 
  mutate(percent = round(n / num_language_responses * 100))
top_15_items <- top_n_choices(languages_used, items, num_language_responses, 15) %>% arrange(percent)
top_15_items <- top_15_items %>%
  mutate(items = factor(as.character(items), levels = items))

bar_chart(top_15_items, 
          column_name = items, 
          fill_color = params$bar_colors, 
          title_string = "What Languages Do You Use With R?",
          subtitle_string = question_text("Qlanguages"),
          caption_string = paste0(survey_name, ", n = ", num_language_responses)) #<<

```

.footnote[
Carl- your bar chart function here needs to be updated to use `num_language_responses`
]

---
# First Language Learned

```{r First Language or Tool Learned}

fl <- survey %>%
  transmute(Input = tolower(Qfirst_language),
            Output = Qfirst_language)

fl <- fl %>% mutate(Output = ifelse(str_detect(Input, "basic"), "Basic", Output),
                    Output = ifelse(str_detect(Input, "fortran"), "Fortran", Output),
                    Output = ifelse(str_detect(Input, "cobol"), "Cobol", Output),
                    Output = ifelse(str_detect(Input, "algol"), "Algol", Output),
                    Output = ifelse(str_detect(Input, "sql"), "SQL", Output),
                    Output = ifelse(str_detect(Input, "html"), "HTML", Output),
                    Output = ifelse(str_detect(Input, "pascal"), "Pascal", Output),
                    Output = ifelse(str_detect(Input, "stata"), "Stata", Output),
                    Output = ifelse(str_detect(Input, "dbase"), "DBase", Output),
                    Output = ifelse(str_detect(Input, "just getting started"), "Just starting programming", Output),
                    Output = ifelse(str_detect(Input, "bash"), "Bash", Output))

# Honestly, the rest of the answers aren't significant, but you can check using the following
# write_delim(fl_tallies, "data/first-language-dictionary.tsv", delim="\t")
                   
fl_tallies <- fl %>% count(Output, sort = TRUE)
num_first_language_responses <- sum(!is.na(fl$Output))
top_15_languages <- top_n_choices(fl_tallies, Output, num_first_language_responses, 15) %>% 
  mutate(Output = factor(Output, levels = rev(Output)))

bar_chart(top_15_languages, 
          column_name = Output, 
          fill_color = params$bar_colors, 
          title_string = "First Language or Tool Learned",
          subtitle_string = question_text("Qfirst_language"),
          caption_string = paste0(survey_name, ", n = ", num_first_language_responses))
```




---
class: inverse, middle

# Learning Questions

---
# R Difficulty (R Users Only)

```{r Difficulty Learning R Experienced}

r_difficulty <- tally_question(survey, Qr_difficulty_experienced, rm.na = TRUE, sort = FALSE)
diff_responses <- first(r_difficulty$nn)
mean_difficulty = round(mean(survey$Qr_difficulty_experienced, na.rm = TRUE), 1)

r_difficulty <- r_difficulty %>%
  mutate(percent = percent / 100)      # the plot below uses a percent y axis

ggplot(r_difficulty) +
  geom_bar(aes(x = Qr_difficulty_experienced, y = percent),
           stat = "identity",
           color = params$bar_colors,
           fill = params$bar_colors,
           width = 0.5,
           alpha = 0.5) +
  geom_text(aes(x = Qr_difficulty_experienced, y = percent,
                label = paste0(round(percent * 100), "%")),
                color = "gray30",
                nudge_y = .03) +
  annotate("text", x = 2, y = 0.4, label = paste0("Mean value = ", mean_difficulty)) +
  scale_y_continuous(labels = scales::percent) +
  labs(title = "Difficulty in Learning R (R Users Only)", 
       subtitle = question_text("Qr_difficulty_experienced", 72),
       caption = paste0(survey_name, ", n = ", diff_responses),
       x="Respondent Rating (1 = Easiest, 5 = Most Difficult)", y="")
```

---
# Time To R Proficiency (R Users Only)

```{r Time to proficiency}

r_proficiency <- tally_question(survey, Qtime_to_proficiency, rm.na = TRUE, sort = TRUE)
r_proficiency <- r_proficiency %>% 
  mutate(Qtime_to_proficiency = factor(Qtime_to_proficiency, levels = rev(Qtime_to_proficiency)))

bar_chart(df                 = r_proficiency,
          column_name        = Qtime_to_proficiency,
          title_string           = "Time To Achieve Proficiency In R (R Users Only)",
          subtitle_string        = question_text("Qtime_to_proficiency", 70),
          caption_string         = paste0("RStudio Learning R Survey, n = ",first(r_proficiency$nn)),
          fill_color             = params$bar_colors)

```

---
# Reason Why Learned R (R Users Only)

```{r Why Learned R}

r_why <- tally_question(survey, Qr_reason_experienced, rm.na = TRUE, sort = TRUE)
r_why <- r_why %>% 
  mutate(Qr_reason_experienced = factor(Qr_reason_experienced, levels = rev(Qr_reason_experienced)))

bar_chart(df                 = r_why,
          column_name        = Qr_reason_experienced,
          title_string           = "Reason To Learn R (R Users Only)",
          subtitle_string        = question_text("Qr_reason_experienced", 40),
          caption_string         = paste0("RStudio Learning R Survey, n = ",first(r_why$nn)),
          fill_color             = params$bar_colors)

```

---

# What is Your Experience with R? (All Respondents)

```{r R Experience so far}
# Multiple categories selected will be separated by commas, so we'll count those as multiple ethnicities
# This will probably miscategorize some open ends, but a quick analysis showed we have very few open ends
# with embedded commas.

r_experience <- tally_question(survey, Qr_experience, rm.na = TRUE, sort = FALSE)
r_experience_responses <- first(r_experience$nn)
r_experience <- r_experience %>% 
 mutate(Qr_experience_factor = factor(Qr_experience, levels = Qr_experience),
         position = cumsum(percent) - percent / 2,
         label = ifelse(percent >= 2, paste0(Qr_experience, "\n", round(percent), "%"), ""))

pie_chart(df                 = r_experience,
          column_name        = Qr_experience_factor,
          text_position          = 100 - position,
          title_string           = "R Experience (All Respondents)",
          subtitle_string        = question_text("Qr_experience"),
          caption_string         = paste0("RStudio Learning R Survey, n = ",r_experience_responses),
          fill_legend_title      = "",
          colors                 = "Set1")

```

---

# How Did You Learn R?  (R Users Only)

```{r How Did You Learn R}
# We shorten down the given answers while categorizing open-text answers given for "Other"
# Just as we did for the gender and industry questions, we use small dictionary to do this
# However, because commas may appear in the open text respones, we'll use a tsv file instead of a csv one.

r_path_dictionary <- read_delim(here::here("data/r-path-dictionary.tsv"), delim = "\t")
r_paths <- survey %>% select(Qr_learning_path) %>% left_join(r_path_dictionary, c("Qr_learning_path" = "Input"))
r_path_results <- tally_question(r_paths, Output, rm.na = TRUE, sort = TRUE)
# answer_table <- r_paths %>% select(Qr_learning_path, n)
# write_delim(answer_table, "data/r-path-dictionary.tsv", delim="\t")
r_path_responses <- first(r_path_results$nn)

r_path_results <- r_path_results %>% 
 mutate(Output = factor(Output, levels = Output),
         position = cumsum(percent) - percent / 2,
         label = ifelse(percent >= 2, paste0(Output, "\n", round(percent), "%"), ""))

pie_chart(df                 = r_path_results,
          column_name        = Output,
          text_position          = 100 - position,
          title_string           = "R Learning Path  (R Users Only)",
          subtitle_string        = question_text("Qr_learning_path"),
          caption_string         = paste0(survey_name, ", n = ", r_path_responses),
          fill_legend_title      = "",
          colors                 = "Set2")


```

---
# Respondent Ages By Learner Type

```{r R Learning Ages By Learner Type}

ages <- survey %>%
  filter(!is.na(learner_type) & Qyear_born < 2010) %>% 
  mutate(age = 2018 - Qyear_born)

mean_ages <- ages %>% 
  group_by(learner_type) %>% 
  summarize(mean_age = mean(age, na.rm = TRUE))

ggplot(ages, aes(x = learner_type, y = age, group = learner_type)) +
  geom_violin(aes(color = learner_type), width = 0.5) +
  geom_jitter(aes(color = learner_type), alpha = 0.1, width = 0.02) +
  scale_y_continuous(breaks = seq(15,90,5)) +
  scale_color_brewer(palette = "Dark2") +
  labs(title = "Respondent Age",
       subtitle = sprintf("Early Learner Mean Age = %d, Recent Learner = %d", 
                          round(mean_ages$mean_age[1]), round(mean_ages$mean_age[2])),
       caption = survey_name,
       x="Learner Type", y="Age", color = "Learner Type")
```

---

# Year Respondents Learned R (All Respondents)

```{r Year respondents learned R}



ggplot(filter(survey, Qr_year >= 1990)) +
  geom_histogram(aes(Qr_year), binwidth = 1, fill = params$bar_colors, color="black") +
  scale_x_continuous(breaks = c(1990, 1995, 2000, 2005, 2010, 2015, 2018)) +
  labs(title = "Year Started Learning R", 
       subtitle = question_text("Qr_year"),
       caption = survey_name,
       x="Year", y="Count")
```

---

# Number of People You Work With That Know R By Learner Type

```{r Number R Team Members}
team_num_survey <- survey %>% filter(!is.na(learner_type))

ggplot(team_num_survey, aes(x = learner_type, y = Qteam_r_users, group = learner_type)) +
  geom_violin(aes(color = learner_type), width = 0.5) +
  geom_jitter(aes(color = learner_type), alpha = 0.1, width = 0.02) +
  scale_y_continuous(trans = "log10") +
  scale_color_brewer(palette = "Dark2") +
  labs(title = "Number of Team Members Who Know R (Density Plot)", 
       subtitle = question_text("Qteam_r_users", 50),
       caption = survey_name,
       x="Learner Type", y="# Team Members", color = "Learner Type")

```

---

# Difficulty of Learning R based on Learner Type

```{r Ages By Learner Type}

ss <- survey %>% filter(!is.na(learner_type) & !is.na(Qr_difficulty_experienced))
ss_grouped <- ss %>% 
  group_by(learner_type, Qr_difficulty_experienced) %>% 
  count(Qr_difficulty_experienced)
ggplot(ss) +
  geom_bar(aes(x = Qr_difficulty_experienced, y = ..prop.., fill = learner_type, group = learner_type),
           position = position_dodge(width = 0.5),
           alpha = 0.5) +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_brewer(palette = "Set1") +
  labs(title = "Difficulty in Learning R", 
       subtitle = question_text("Qr_difficulty_experienced"),
       caption = "2018 RStudio Learning R Survey",
 x="Respondent Rating (5 = Most Difficult)", y="", fill = "Learner Type")
```

---
class: middle


.left-column[

## What is R Used For?

]


.right-column[


```{r R Used For, eval = FALSE}
# Breaks up uses into nested lists
uses <- survey %>% mutate(application = map(Qused_for, str_split, ", ")) %>% unnest()
tools_used <- uses %>% unnest() %>% group_by(application) %>% count(sort=TRUE)
# Count the non-NA entries now
use_responses <- survey %>% summarize(responses = sum(!is.na(Qused_for)))
tools_used <- tools_used %>% mutate(percent = round(n / use_responses$responses * 100)) %>% arrange(desc(percent))
app_plot <- head(tools_used, 15) %>% ungroup()
other <- tail(tools_used, -15) %>% 
  ungroup() %>% 
  summarize(application = "Other", 
            n = sum(n), 
            percent = round(n / use_responses$responses * 100))
app_plot <- rbind(app_plot, other) %>% drop_na()
ggplot(app_plot) +
  geom_col(aes(x=reorder(application, percent), y = percent),
           fill =  params$bar_colors) +
  geom_text(aes(x=reorder(application, percent), y = percent / 2 + 1, label = paste0(percent, "%")), 
            color="white", size=3) +
  labs(title = "What Do You Use R For?", 
       subtitle = question_text("Qused_for"),
       caption = "2018 RStudio Learning R Survey",
x="Application", y="Percent") +
  coord_flip()

```


---
name: alison-r-used-for
class: middle

.left-column[

## What is R used for?

]

.right-column[


```{r alison-r-used-for}
survey_used <- survey %>% 
  mutate(Qused_for = if_else(Qused_for == "GIS", 
                             Qused_for, 
                             str_to_title(Qused_for)))
used_for <- chop_and_prop(survey_used, Qused_for, num_items = 14) 

lollipop_chart(used_for, 
          column_name = items, 
          fill_color = params$bar_colors, 
          title_string = "What is R used for?",
          subtitle_string = question_text("Qused_for"),
          caption_string = paste0(survey_name, ", n = ", used_for$total_responses))
```
]

---
class: middle
name: net-promotor-score

.left-column[
## Net Promoter Score
]

.right-column[

```{r Net Promoter Score}
recommend_totals <-survey %>% group_by(Qrecommend) %>% tally()
responses <- sum(recommend_totals$n, na.rm = TRUE)
recommend_totals <- recommend_totals %>% mutate(percent = n / responses * 100)
recommend_scores <- tibble(Qrecommend = 1:10) %>% left_join(recommend_totals, by = "Qrecommend")
nps <- round(sum(recommend_scores$percent[9:10], na.rm=TRUE) - 
               sum(recommend_scores$percent[1:6], na.rm=TRUE))  # Standard NPS formula (see Wikipedia)
npr <- nps %>% cut(breaks = c(-100, 0, 50, 75, 100), labels = c("Dangerous", "Good", "Excellent", "World Class"))

ggplot(recommend_scores) +
  geom_col(aes(x = Qrecommend, y = percent), fill = params$bar_colors, color="black") +
  geom_text(aes(x = Qrecommend, y = percent + 3, label = paste0(round(percent), "%")), 
            color="black", size=3) +
  scale_x_continuous(breaks = 1:10) +
    labs(title = question_text("Qrecommend"),
       subtitle = sprintf("Net Promoter Score = %s,        Rating: %s", nps, npr),
       caption = "2018 RStudio Learning R Survey",
       x="Score", y="Count")
```
]

---
class: middle


.left-column[
## What Tools Do You Use With R?
]

.right-column[

```{r R Tools Used}
uses <- survey %>% transmute(tools = str_replace_all(Qtools_with_r, "i.e., ", ""))
num_tool_responses <- sum(!is.na(survey$Qtools_with_r))
tools_used <- split_and_aggregate(uses, tools)
tools_used <- tools_used %>% 
  select(-num_responses) %>% 
  mutate(percent = round(n / num_tool_responses * 100))
top_15_items <- top_n_choices(tools_used, items, num_tool_responses, 15) %>% arrange(percent)
top_15_items <- top_15_items %>%
  mutate(items = factor(as.character(items), levels = items))

bar_chart(top_15_items, 
          column_name = items, 
          fill_color = params$bar_colors, 
          title_string = "What Tools Do You Use With R?  (R Users Only)",
          subtitle_string = question_text("Qtools_with_r"),
          caption_string = paste0(survey_name, ", n = ", num_tool_responses))
```
]

.footnote[
R Users Only
]

---
class: middle
name: alison-other-tools

.left-column[
## What Tools Do You Use With R?
]

.right-column[

```{r alison-other-tools}
tools_used <- chop_and_prop(survey, Qtools_with_r, num_items = 15) 

lollipop_chart(tools_used, 
          column_name = items, 
          fill_color = params$bar_colors, 
          #title_string = "What Tools Do You Use With R?",
          subtitle_string = question_text("Qtools_with_r"),
          caption_string = paste0(survey_name, ", n = ", tools_used$total_responses))
```
]

.footnote[
R Users Only
]

---
class: middle

.left-column[

## Greatest Difficulty in Learning R
]  

.right-column[

```{r Greatest difficulting learning}

difficulty_answers <- survey %>% select(Qbiggest_difficulty) %>% filter(!is.na(Qbiggest_difficulty))
num_difficulties <- sum(!is.na(survey$Qbiggest_difficulty))
difficulties <- split_and_aggregate(difficulty_answers, Qbiggest_difficulty)
difficulties <- difficulties %>% 
  mutate(percent = round(n / num_difficulties * 100)) %>% 
  select(-num_responses)
top_12_difficulties <- top_n_choices(difficulties, items, num_difficulties, 12)
top_12_difficulties <- top_12_difficulties %>%
  mutate(items = factor(as.character(items), levels = rev(items)))

bar_chart(top_12_difficulties, 
          column_name = items, 
          fill_color = params$bar_colors, 
          title_string = "Difficulties In Learning R  (R Users Only)",
          subtitle_string = question_text("Qbiggest_difficulty"),
          caption_string = paste0(survey_name, ", n = ", num_difficulties))

```
]

---
class: middle

.left-column[
## Frequency of R Use 
]

.right-column[
```{r Frequency of R Use}

r_use_frequency <- survey %>% select(Qr_how_often_used)
r_use_results <- tally_question(r_use_frequency, Qr_how_often_used, rm.na = TRUE, sort = TRUE)
# answer_table <- r_paths %>% select(Qr_learning_path, n)
# write_delim(answer_table, "data/r-path-dictionary.tsv", delim="\t")
r_use_responses <- first(r_use_results$nn)

r_use_results <- r_use_results %>% 
 mutate(Qr_how_often_used = factor(Qr_how_often_used, levels = rev(Qr_how_often_used)),
         position = cumsum(percent) - percent / 2,
         label = ifelse(percent >= 2, paste0(Qr_how_often_used, "\n", round(percent), "%"), ""))

bar_chart(df                 = r_use_results,
          column_name        = Qr_how_often_used,
          title_string           = "Frequency of R Use (R Users Only)",
          subtitle_string        = question_text("Qr_how_often_used"),
          caption_string         = paste0(survey_name, ", n = ", r_use_responses),
          fill_color             = params$bar_colors)


```
]

.footnote[
(R Users Only)
]

---
class: middle

.left-column[
## R Enjoyment

]

.right-column[

```{r R Enjoyment}

r_enjoyment <- tally_question(survey, Qr_enjoyment, rm.na = TRUE, sort = FALSE)
diff_responses <- first(r_enjoyment$nn)
mean_enjoyment = round(mean(survey$Qr_enjoyment, na.rm = TRUE), 1)

r_enjoyment <- r_enjoyment %>%
  mutate(percent = percent / 100)      # the plot below uses a percent y axis

ggplot(r_enjoyment) +
  geom_bar(aes(x = Qr_enjoyment, y = percent),
           stat = "identity",
           color = params$bar_colors,
           fill = params$bar_colors,
           width = 0.5,
           alpha = 0.5) +
  geom_text(aes(x = Qr_enjoyment, y = percent,
                label = paste0(round(percent * 100), "%")),
                color = "gray30",
                nudge_y = .03) +
  geom_vline(aes(xintercept = mean_enjoyment), color = "green") +
  annotate("text", x = 4, y = 0.5, label = paste0("Mean value = ", mean_enjoyment)) +
  scale_y_continuous(labels = scales::percent) +
  labs(title = "Enjoyment Using R (R Users Only)", 
       subtitle = question_text("Qr_enjoyment", 60),
       caption = paste0(survey_name, ", n = ", diff_responses),
       x="Respondent Rating (1 = Not at all, 5 = A great deal)", y="")
```

]  

.footnote[
 (R Users Only)
]

---
class: middle

.left-column[
## Tidyverse Learning 
]

.right-column[

```{r tidyverse Learning}

learned_with_tidyverse <- tally_question(survey, Qtidyverse_learning, rm.na = TRUE, sort = TRUE)
learned_with_tidyverse_responses <- first(learned_with_tidyverse$nn)
learned_with_tidyverse <- learned_with_tidyverse %>% 
 mutate(Qtidyverse_learning_factor = factor(Qtidyverse_learning, levels = Qtidyverse_learning),
         position = cumsum(percent) - percent / 2,
         label = ifelse(percent >= 2, paste0(Qtidyverse_learning, "\n", round(percent), "%"), ""))

pie_chart(df                 = learned_with_tidyverse,
          column_name        = Qtidyverse_learning_factor,
          text_position          = 100 - position,
          title_string           = "Learned With Tidyverse (R Users Only)",
          subtitle_string        = question_text("Qtidyverse_learning"),
          caption_string         = paste0(survey_name, ", n = ",learned_with_tidyverse_responses),
          fill_legend_title      = "",
          #reverse_fill_legend    = FALSE,
          colors                 = "Set1")

```
]

.footnote[
(R Users Only)
]

---
class: middle

.left-column[
## Tidyverse Use 
]

.right-column[
```{r tidyverse}

tidyverse_use <- tally_question(survey, Qtidyverse_today, rm.na = TRUE, sort = TRUE)
tidyverse_use_responses <- first(tidyverse_use$nn)
tidyverse_use <- tidyverse_use %>% 
 mutate(Qtidyverse_today_factor = factor(Qtidyverse_today, levels = Qtidyverse_today),
         position = cumsum(percent) - percent / 2,
         label = ifelse(percent >= 2, paste0(Qtidyverse_today, "\n", round(percent), "%"), ""))

pie_chart(df                 = tidyverse_use,
          column_name        = Qtidyverse_today_factor,
          text_position          = 100 - position,
          title_string           = "Tidyverse Use Frequency Today (R Users Only)",
          subtitle_string        = question_text("Qtidyverse_today"),
          caption_string         = paste0(survey_name, ", n = ",tidyverse_use_responses),
          fill_legend_title      = "",
          #reverse_fill_legend    = FALSE,
          colors                 = "Set1")

```
]

.footnote[
(R Users Only)
]

